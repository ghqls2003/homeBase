<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="vfc.drvVfcHist">

    <!-- 자격확인이력 조회 -->
    <select id="listView" parameterType="paraMap" resultType="resultMap">
        SELECT *
        FROM(
        SELECT T.*
        FROM (
        SELECT row_number() over( order by vrfc_dmnd_dt desc) as SN
        , vrfc_hstry_sn
        , rqstr_sn
        , drma.co_nm
		, case
			when viui.sso_user_nm is not null then
				concat(left(viui.sso_user_nm, 1), repeat('*', length(viui.sso_user_nm) - 2), right(viui.sso_user_nm, 1))
			when viui.onepass_user_nm is not null then
				concat(left(viui.onepass_user_nm, 1), repeat('*', length(viui.onepass_user_nm) - 2), right(viui.onepass_user_nm, 1))
			else null
		end as rqstr_nm
		, '*******' || SUBSTRING(dqvs.pca_decrypt(dln, '150'), 8) AS dln
        , brdt
        , lcns_asort_cd
        , CASE ddhv.lcns_asort_cd
        WHEN '11' THEN '1종대형'
        WHEN '12' THEN '1종보통'
        WHEN '13' THEN '1종소형'
        WHEN '14' THEN '대형견인'
        WHEN '15' THEN '구난차'
        WHEN '16' THEN '소형견인'
        WHEN '32' THEN '2종보통'
        WHEN '33' THEN '2종소형'
        WHEN '38' THEN '원동기'
        ELSE lcns_asort_cd END AS lcns_type
        , vrfc_dmnd_dt
        , rent_bgng_dt
        , rent_end_dt
        , (CASE vrfc_mthd WHEN '1' THEN '직접입력' WHEN '2' THEN 'OCR' WHEN '3' THEN '모바일면허증' when '4' then 'API' end) as vrfc_mthd
        , ddhv.vrfc_cd as verify_cd
        ,       CASE
        when ddhv.vrfc_rslt = '00'or ddhv.vrfc_rslt = '1' or ddhv.vrfc_rslt = '0'
        then dqvs.fn_get_cdnm('verify_cd', ddhv.vrfc_cd)
        else dqvs.fn_get_cdnm('vrfc_rslt', ddhv.vrfc_rslt)
        end as verify_nm
        , ddhv.vrfc_rslt as vrfc_rslt_cd
        , prcs_se
        , drma.bzmn_sn
        FROM dqvs.dvs_dqv_hs_verf AS ddhv
        LEFT OUTER JOIN dqvs.v_intg_user_info AS viui  ON ddhv.rqstr_sn = viui.user_sn
        LEFT OUTER JOIN dqvs.dvs_rac_mt_agency AS drma ON viui.bzmn_sn = drma.bzmn_sn
        <!-- 권한처리 -->
        <choose>
            <when test='authrtCd.indexOf("Z") != -1 or authrtCd.indexOf("M") != -1 or authrtCd.indexOf("K") != -1 or authrtCd.indexOf("D") != -1'> <!-- 관리자/공단/국토부/개발자 -->
                WHERE 1 = 1
            </when>
            <when test='authrtCd.indexOf("G") != -1'> <!-- 지자체,대여사업조합 : 관할지역 내 사업자의 사용자 -->
                WHERE viui.user_sn IN (
                SELECT user_sn
                FROM dqvs.dvs_cmm_mt_user
                <choose>
                    <when test="subSignguCd != null  and subSignguCd != ''">
                        WHERE cmptnc_zone_cd like  #{subSignguCd} ||'%'
                    </when>
                    <otherwise> <!-- 지자체,조합 권한인데 관할구역코드가 없으면 데이터 조회 안되게 -->
                        WHERE cmptnc_zone_cd = '999999998888333'
                    </otherwise>
                </choose>
                )
            </when>
            <when test='authrtCd.equals("S01")'> <!-- 주사무소관리자면 : 해당 사용자의 사업자일련번호를 가진 사용자 또는 해당 사업자 일련번호를 상위 사업자로 가지는 업체의 사용자가 조회한 건까지 표시 -->
                WHERE viui.bzmn_sn IN (select bzmn_sn from dqvs.dvs_rac_mt_agency where up_brno = #{bzmnSn} or bzmn_sn = #{bzmnSn})
            </when>
            <when test='authrtCd.equals("S02")'> <!-- 영업소관리자면 : 해당 사업자일련번호를 가진 사용자가 조회한 건만 표시 -->
                WHERE viui.bzmn_sn = #{bzmnSn}
            </when>
            <otherwise> <!-- 그 외(일반사용자 포함)는 로그인 당사자의 조회 건만 표시 -->
                WHERE viui.user_sn = #{userSn}::numeric
            </otherwise>
        </choose>
        <!-- 조회조건 -->
        <if test="startDtTm != null and startDtTm != '' and endDtTm != null and endDtTm != ''">
            AND vrfc_dmnd_dt <![CDATA[>=]]> #{startDtTm}::timestamp AND vrfc_dmnd_dt <![CDATA[<=]]> #{endDtTm}::timestamp
        </if>
        <if test="vrfcMthd != null and vrfcMthd != ''">
            AND vrfc_mthd = #{vrfcMthd}
        </if>
        <if test="dln != null and dln != ''">
            AND dln = dqvs.pca_encrypt(#{dln},'150')
        </if>
        <if test="cd != null and cd != '' ">
            <choose>
                <when test="codeType =='verify'"><!--요청 성공 후 확인결과 실패(vrfc_cd 컬럼 조회시 ) 일때 -->
                    AND ddhv.vrfc_cd = #{cd}
                </when>
                <when test="codeType =='vrfc'"><!--요청 실패 일때 (vrfc_rslt 컬럼 조회시 )-->
                    AND ddhv.vrfc_rslt = #{cd}
                </when>
            </choose>
        </if>

        <if test="bzmnSnKwd != null and bzmnSnKwd != ''">
            AND (drma.bzmn_sn LIKE '%' || #{bzmnSnKwd} || '%' OR drma.co_nm LIKE '%' || #{bzmnSnKwd} || '%')
        </if>
        <if test="rqstrNm != null  and rqstrNm != ''">
            AND (viui.sso_user_nm LIKE '%' || #{rqstrNm} || '%' OR viui.onepass_user_nm LIKE '%' || #{rqstrNm} || '%')
        </if>
        ) T
        <choose>
            <when test="take != '' and take != null">
                <choose>
                    <when test="skip != '' and skip != null"> <!-- Keyset Pagination 우선 적용 -->
                        WHERE T.SN <![CDATA[>]]> #{skip}
                    </when>
                    <when test="page != '' and page != null"> <!-- skip 없으면 Offset Pagination -->
                        OFFSET ((#{page} - 1) * #{take})
                    </when>
                    <otherwise>
                        WHERE T.SN <![CDATA[>]]> 0
                    </otherwise>
                </choose>
                LIMIT #{take}
            </when>
            <otherwise>
                LIMIT 50000	<!-- 아무런 조건이 없을 경우 최대 5만건 까지만 조회되도록 제한 -->
            </otherwise>
        </choose>
        ) AS TT
    </select>

    <!-- 자격확인이력 건수 조회 -->
    <select id="listViewCnt" resultType="int">
        SELECT count(1) AS cnt
        FROM dqvs.dvs_dqv_hs_verf AS ddhv
        LEFT OUTER JOIN dqvs.v_intg_user_info AS viui  ON ddhv.rqstr_sn = viui.user_sn
        LEFT OUTER JOIN dqvs.dvs_rac_mt_agency AS drma ON viui.bzmn_sn = drma.bzmn_sn
        <!-- 권한처리 -->
        <choose>
            <when test='authrtCd.indexOf("Z") != -1 or authrtCd.indexOf("M") != -1 or authrtCd.indexOf("K") != -1 or authrtCd.indexOf("D") != -1'> <!-- 관리자/공단/국토부/개발자 -->
                WHERE 1 = 1
            </when>
            <when test='authrtCd.indexOf("G") != -1'> <!-- 지자체,대여사업조합 : 관할지역 내 사업자의 사용자 -->
                WHERE viui.user_sn IN (
                SELECT user_sn
                FROM dqvs.dvs_cmm_mt_user
                <choose>
                    <when test="subSignguCd != null  and subSignguCd != ''">
                        WHERE cmptnc_zone_cd like  #{subSignguCd} ||'%'
                    </when>
                    <otherwise> <!-- 지자체,조합 권한인데 관할구역코드가 없으면 데이터 조회안되게 -->
                        WHERE cmptnc_zone_cd = '999999998888333'
                    </otherwise>
                </choose>
                )
            </when>
            <when test='authrtCd.equals("S01")'> <!-- 주사무소관리자면 : 해당 사용자의 사업자일련번호를 가진 사용자 또는 해당 사업자 일련번호를 상위 사업자로 가지는 업체의 사용자가 조회한 건까지 표시 -->
                WHERE viui.bzmn_sn IN (select bzmn_sn from dqvs.dvs_rac_mt_agency where up_brno = #{bzmnSn} or bzmn_sn = #{bzmnSn})
            </when>
            <when test='authrtCd.equals("S02")'> <!-- 영업소관리자면 : 해당 사업자일련번호를 가진 사용자가 조회한 건만 표시 -->
                WHERE viui.bzmn_sn = #{bzmnSn}
            </when>
            <otherwise> <!-- 그 외는 로그인 당사자의 조회 건만 표시 -->
                WHERE viui.user_sn = #{userSn}::numeric
            </otherwise>
        </choose>
        <!-- 조회조건 -->
        <if test="startDtTm != null and startDtTm != '' and endDtTm != null and endDtTm != ''">
            AND vrfc_dmnd_dt <![CDATA[>=]]> #{startDtTm}::timestamp AND vrfc_dmnd_dt <![CDATA[<=]]> #{endDtTm}::timestamp
        </if>
        <if test="vrfcMthd != null and vrfcMthd != ''">
            AND vrfc_mthd = #{vrfcMthd}
        </if>
        <if test="dln != null and dln != ''">
            AND dln = dqvs.pca_encrypt(#{dln},'150')
        </if>
        <if test="cd != null and cd != '' ">
            <choose>
                <when test="codeType =='verify'"><!--요청 성공 후 확인결과 실패(vrfc_cd 컬럼 조회시 ) 일때 -->
                    AND ddhv.vrfc_cd = #{cd}
                </when>
                <when test="codeType =='vrfc'"><!--요청 실패 일때 (vrfc_rslt 컬럼 조회시 )-->
                    AND ddhv.vrfc_rslt = #{cd}
                </when>
            </choose>
        </if>
        <if test="bzmnSnKwd != null and bzmnSnKwd != ''">
            AND (drma.bzmn_sn LIKE '%' || #{bzmnSnKwd} || '%' OR drma.co_nm LIKE '%' || #{bzmnSnKwd} || '%')
        </if>
        <if test="rqstrNm != null  and rqstrNm != ''">
            AND (viui.sso_user_nm LIKE '%' || #{rqstrNm} || '%' OR viui.onepass_user_nm LIKE '%' || #{rqstrNm} || '%')
        </if>
    </select>



    <!-- 확인결과 리스트 -->
    <select id="ckResults" resultType="resultMap">
        SELECT *
        FROM (
        (select cd_nm,concat(cd_group,'_', cd) as cd
        FROM dqvs.dvs_cmm_mt_code
        WHERE cd_group = 'verify_cd' and use_yn ='Y' and del_yn='N'
        )
        UNION ALL
        (SELECT cd_nm,concat(cd_group,'_', cd) as cd
        FROM dqvs.dvs_cmm_mt_code
        WHERE cd_group = 'vrfc_rslt' and use_yn ='Y' and del_yn='N'
        )
        ) AS rescd
        order by cd_nm asc
    </select>
</mapper>