<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sys.smsSend">
	
	<!-- 검색옵션 - 계정상태(전체) -->
	<select id="selectSttsCd" resultType="map">
        select cd_nm from dqvs.dvs_cmm_mt_code
        where cd_nm != '정상' and cd_nm != '삭제' and cd_group = 'acnt_stts_cd' or cd_group  = 'aprv_stts_cd'
    </select>

 	<!-- 검색옵션 - 권한(전체) -->
	<select id="selectAuth" resultType="map">
		select authrt_cd, authrt_nm 
		from dqvs.dvs_cmm_mt_auth
		where use_yn = 'Y'		
		and authrt_cd in ('S01', 'S02', 'S03', 'S04', 'S05', 'G01')
		order by authrt_cd asc
    </select>
    
    <!-- 검색옵션 - 시도(전체) -->
    <select id="selectCtpvNm" resultType="map">
        select distinct
		    substring(stdg_cd, 1, 2) AS ctpv_cd, ctpv_nm
		from
		    dqvs.dvs_cmm_mt_area
		where mtnabn_yn = 'Y'
		<if test="userCmptncZoneCd != null and userCmptncZoneCd != ''">
			and stdg_cd = #{userCmptncZoneCd}
		</if>
		order by
		    ctpv_cd
    </select>
    
    <!-- 검색옵션 - 시군구(전체) -->
    <select id="selectSggNm" resultType="map">
        select distinct
			SUBSTRING(stdg_cd, 3, 3) AS sgg_cd, sgg_nm
		from dqvs.dvs_cmm_mt_area
		where mtnabn_yn = 'Y'
			and sgg_nm != ''
		<if test="ctpvCd != null and ctpvCd != ''">
			and stdg_cd LIKE CONCAT(#{ctpvCd}, '%')
		</if>
		<if test="userCmptncZoneCd != null and userCmptncZoneCd != ''">
			and stdg_cd = #{userCmptncZoneCd}
		</if>
		order by sgg_cd
    </select>
    
    
    <!-- 법인명 자동조건 검색 -->
    <select id="selectCrno" resultType="map">

<!-- 	    select -->
<!-- 			distinct T1.crno -->
<!-- 		    		, -->
<!-- 			T1.co_nm -->
<!-- 		from -->
<!-- 			( -->
<!-- 			select -->
<!-- 				T3.* -->
<!-- 			from -->
<!-- 				( -->
<!-- 				select  -->
<!-- 					Tuser.user_sn -->
<!-- 						, -->
<!-- 					coalesce(Tsso.user_id, -->
<!-- 					Tone."ci", -->
<!-- 					'-') as user_id -->
<!-- 						, -->
<!-- 					coalesce(Tsso.user_nm, -->
<!-- 					Tone.user_nm, -->
<!-- 					'-') as user_nm -->
<!-- 						, -->
<!-- 					Tuser.authrt_cd -->
<!-- 						, -->
<!-- 					( -->
<!-- 					select -->
<!-- 						authrt_nm -->
<!-- 					from -->
<!-- 						dqvs.dvs_cmm_mt_auth -->
<!-- 					where -->
<!-- 						authrt_cd = Tuser.authrt_cd) -->
<!-- 						, -->
<!-- 					coalesce(( -->
<!-- 					select -->
<!-- 						case -->
<!-- 							when drma.co_nm1 is not null then drma.co_nm1 -->
<!-- 							when drma.co_nm2 is not null then drma.co_nm2 -->
<!-- 							else null -->
<!-- 						end as co_nm -->
<!-- 					from -->
<!-- 						( -->
<!-- 						select -->
<!-- 							co_nm as co_nm1, -->
<!-- 							null as co_nm2 -->
<!-- 						from -->
<!-- 							dqvs.dvs_rac_mt_agency Tagency -->
<!-- 						where -->
<!-- 							bzmn_sn = Tuser.bzmn_sn -->
<!-- 					union all -->
<!-- 						select -->
<!-- 							null as co_nm1, -->
<!-- 							co_nm as co_nm2 -->
<!-- 						from -->
<!-- 							dqvs.dvs_rac_mt_request -->
<!-- 						where -->
<!-- 							bzmn_sn = Tuser.bzmn_sn) drma -->
<!-- 					limit 1), -->
<!-- 					'-') as co_nm, -->
<!-- 						case -->
<!-- 							when acnt_stts_cd = '1' then ( -->
<!-- 						select -->
<!-- 							cd_nm -->
<!-- 						from -->
<!-- 							dqvs.dvs_cmm_mt_code -->
<!-- 						where -->
<!-- 							cd_group = 'aprv_stts_cd' -->
<!-- 							and cd = Tuser.aprv_stts_cd) -->
<!-- 						else ( -->
<!-- 						select -->
<!-- 							cd_nm -->
<!-- 						from -->
<!-- 							dqvs.dvs_cmm_mt_code -->
<!-- 						where -->
<!-- 							cd_group = 'acnt_stts_cd' -->
<!-- 							and cd = acnt_stts_cd) -->
<!-- 					end as stts_cd -->
<!-- 					, coalesce(dqvs.pca_decrypt(Tsso.mbl_telno, -->
<!-- 					'150'), -->
<!-- 					dqvs.pca_decrypt(Tone.mbl_telno, -->
<!-- 					'150'), -->
<!-- 					dqvs.pca_decrypt(Tagency.telno, -->
<!-- 					'150'), -->
<!-- 					dqvs.pca_decrypt(Tuser.assi_telno, -->
<!-- 					'150'), -->
<!-- 					'-') as telno -->
<!-- 						, -->
<!-- 					cmptnc_zone_cd -->
<!-- 						, -->
<!-- 					ctpv_nm -->
<!-- 						, -->
<!-- 					sgg_nm -->
<!-- 						, -->
<!-- 					Tagency.crno -->
<!-- 				from -->
<!-- 					dqvs.dvs_cmm_mt_user Tuser -->
<!-- 				left join dqvs.dvs_cmm_mt_sso Tsso -->
<!-- 						on -->
<!-- 					Tuser.user_sn = Tsso.user_sn -->
<!-- 				left join dqvs.dvs_cmm_mt_onepass Tone on -->
<!-- 					Tsso.user_sn = Tone.user_sn -->
<!-- 				left join dqvs.dvs_rac_mt_agency Tagency -->
<!-- 						on -->
<!-- 					Tuser.bzmn_sn = Tagency.bzmn_sn -->
<!-- 				left join ( -->
<!-- 					select -->
<!-- 								stdg_cd, -->
<!-- 								ctpv_nm, -->
<!-- 								sgg_nm -->
<!-- 					from -->
<!-- 								dqvs.dvs_cmm_mt_area)g -->
<!-- 							on -->
<!-- 					Tuser.cmptnc_zone_cd = g.stdg_cd -->
<!-- 				where -->
<!-- 					Tuser.authrt_cd in ('S01', 'S02', 'S03') -->
<!-- 					)as T3 -->
<!-- 			where -->
<!-- 				1 = 1 -->
<!-- 				and telno NOT IN ('', '-') -->
<!-- 				and user_nm NOT IN ('', '-') -->
<!-- 				and crno != '' -->
<!-- 				)as T1 -->
<!-- 		where -->
<!-- 			1 = 1 -->
		select crno, co_nm from dqvs.dvs_rac_mt_agency 
		where 1=1
		and up_brno is null
		and bzmn_se_cd = '1'
		and crno is not null
		and bsn_stts_cd = '0'
		<if test="userCmptncZoneCd != '' and userCmptncZoneCd != null">
			and reg_cmptnc_cd like #{userCmptncZoneCd} || '%'
		</if>
    </select>

    
   	<!-- 발송이력 그리드 sql -->
	<sql id="SmsSendInfoSql">
	<if test="dateType.equals('send_date') and startDt != '' and startDt != null and endDt != '' and endDt != null">
    (
    	select
    		row_number() over(
			order by T1.sndng_dt desc) rn ,
			T1.cn ,
			T1.rsvt_yn ,
			TO_CHAR(T1.sndng_dt, 'YYYY-MM-DD HH24:MI:SS') as sndng_dt,
			TO_CHAR(T1.sndng_rsvt_dt, 'YYYY-MM-DD HH24:MI:SS') as sndng_rsvt_dt,
			T1.rcvr,
			T1.rcvr_telno,
			T1.sndr_sn
		from(
			select 
				cn
				, rsvt_yn
				, sndng_dt
				, sndng_rsvt_dt
				, rcvr
				, dqvs.pca_decrypt(rcvr_telno, '150') rcvr_telno
				, sndr_sn
			from dqvs.dvs_cmm_hs_sms_send
			)as T1
		where 1 = 1
        	and (T1.sndng_rsvt_dt BETWEEN #{startDt}::TIMESTAMP AND #{endDt}::DATE + '23:59:59'::INTERVAL)
        	and sndr_sn=#{userSn}::numeric
		<if test="sendType != '' and sendType != null">
           	and T1.rsvt_yn = #{sendType}
		</if>
		<if test='searchType == "msg"'>
			and T1.cn like '%' || #{searchWrd} || '%'
		</if>
		<if test='searchType == "user_nm"'>
			and T1.rcvr like '%' || #{searchWrd} || '%'
		</if>
		<if test='searchType == "telno"'>
			and T1.rcvr_telno like '%' || #{searchWrd} || '%'
		</if>
	)AS T2
	</if>
	<if test="dateType.equals('now_date') and startDt != '' and startDt != null and endDt != '' and endDt != null">
    (
    	SELECT 
    		row_number() over(
			order by T1.sndng_dt desc) rn ,
			T1.cn ,
			T1.rsvt_yn ,
			TO_CHAR(T1.sndng_dt, 'YYYY-MM-DD HH24:MI:SS') as sndng_dt,
			TO_CHAR(T1.sndng_rsvt_dt, 'YYYY-MM-DD HH24:MI:SS') as sndng_rsvt_dt,
			T1.rcvr,
			T1.rcvr_telno,
			T1.sndr_sn
		FROM(
			SELECT 
				cn
				, rsvt_yn
				, sndng_dt
				, sndng_rsvt_dt
				, rcvr
				, dqvs.pca_decrypt(rcvr_telno, '150') rcvr_telno
				, sndr_sn
			FROM dqvs.dvs_cmm_hs_sms_send
			)AS T1
		WHERE 1 = 1
        	AND (T1.sndng_dt BETWEEN #{startDt}::TIMESTAMP AND #{endDt}::DATE + '23:59:59'::INTERVAL)
        	and sndr_sn=#{userSn}::numeric
		<if test="sendType != '' and sendType != null">
           	AND T1.rsvt_yn = #{sendType}
		</if>
		<if test='searchType == "msg"'>
			and T1.cn like '%' || #{searchWrd} || '%'
		</if>
		<if test='searchType == "user_nm"'>
			and T1.rcvr like '%' || #{searchWrd} || '%'
		</if>
		<if test='searchType == "telno"'>
			and T1.rcvr_telno like '%' || #{searchWrd} || '%'
		</if>
	)AS T2
	</if>
    </sql>
    
    <!-- 그룹 발송 그리드 sql -->
    <sql id="GroupReceiverListSql">
    (
   	select ROW_NUMBER() OVER(ORDER BY co_nm DESC) rn
		, T2.*
    	FROM
    		(
	    	select T1.*
				, case
			       when user_sn in (
					select
						user_sn
					from
						dqvs.dvs_cmm_mt_sso) then 'sso'
					when user_sn in (
					select
						user_sn
					from
						dqvs.dvs_cmm_mt_onepass) then 'onepass'
					else '-'
			    end as source_table,
			    case
					when user_sn in (
					select
						user_sn
					from
						dqvs.dvs_api_mt_key) then 'Y'
					else 'N'
				end as api
			from
				(
					select
						*
					from
						(
						select
							Tuser.user_sn
							, coalesce(Tsso.user_id,
							Tone."ci",
							'-') as user_id ,
							coalesce(Tsso.user_nm,
							Tone.user_nm,
							'-') as user_nm
							, Tuser.authrt_cd
							, (
							select
								authrt_nm
							from
								dqvs.dvs_cmm_mt_auth
							where
								authrt_cd = Tuser.authrt_cd)
							, coalesce((
							select
								case
									when drma.co_nm1 is not null then drma.co_nm1
									when drma.co_nm2 is not null then drma.co_nm2
									else null
								end as co_nm
							from
								(
								select
									co_nm as co_nm1,
									null as co_nm2
								from
									dqvs.dvs_rac_mt_agency Tagency
								where
									bzmn_sn = Tuser.bzmn_sn
							union all
								select
									null as co_nm1,
									co_nm as co_nm2
								from
									dqvs.dvs_rac_mt_request
								where
									bzmn_sn = Tuser.bzmn_sn) drma
							limit 1),
							'-') as co_nm,
							case
								when acnt_stts_cd = '1' then (
								select
									cd_nm
								from
									dqvs.dvs_cmm_mt_code
								where
									cd_group = 'aprv_stts_cd'
									and cd = Tuser.aprv_stts_cd)
								else (
								select
									cd_nm
								from
									dqvs.dvs_cmm_mt_code
								where
									cd_group = 'acnt_stts_cd'
									and cd = acnt_stts_cd)
							end as stts_cd
							, coalesce(
							NULLIF(TRIM(dqvs.pca_decrypt(Tuser.assi_telno,
							'150')), ''),
							NULLIF(TRIM(dqvs.pca_decrypt(Tsso.mbl_telno,
							'150')), ''),
							NULLIF(TRIM(dqvs.pca_decrypt(Tone.mbl_telno,
							'150')), ''),
							NULLIF(TRIM(dqvs.pca_decrypt(Tagency.telno,
							'150')), ''),
							'-') as telno
							, COALESCE(nullif(Tuser.cmptnc_zone_cd,''),nullif(Tagency.reg_cmptnc_cd,'')) as cmptnc_zone_cd
							, ctpv_nm
							, sgg_nm
							, Tagency.crno
							, acnt_stts_cd
							, Tagency.bsn_stts_cd
						from
							dqvs.dvs_cmm_mt_user Tuser
						left join dqvs.dvs_cmm_mt_sso Tsso on
							Tuser.user_sn = Tsso.user_sn
						left join dqvs.dvs_cmm_mt_onepass Tone on
							Tsso.user_sn = Tone.user_sn
						left join dqvs.dvs_rac_mt_agency Tagency on
							Tuser.bzmn_sn = Tagency.bzmn_sn
						left join (
							select
								stdg_cd,
								ctpv_nm,
								sgg_nm
							from
								dqvs.dvs_cmm_mt_area)g
							on Tuser.cmptnc_zone_cd = g.stdg_cd or Tagency.reg_cmptnc_cd = g.stdg_cd
						where Tuser.authrt_cd IN ('S01','S02','S04','S05')
					) as T3
					where
						user_sn in (
						select
							user_sn
						from
							dqvs.dvs_cmm_mt_sso)
						or user_sn in (
						select
							user_sn
						from
							dqvs.dvs_cmm_mt_onepass)
				) as T1
			where 1 = 1
			and telno NOT IN ('', '-')
			and user_nm NOT IN ('', '-')
			and stts_cd = '승인'
			and bsn_stts_cd = '0'
			<if test="userCmptncZoneCd != null and userCmptncZoneCd != ''">
				and cmptnc_zone_cd like #{userCmptncZoneCd}||'%'
			</if>
			<if test='except_tel.equals("true")'>
				and telno like '01%'
			</if>
			<if test='auth_01.equals("true") or auth_02.equals("true") or auth_03.equals("true") or auth_04.equals("true")'>
			and(
				<choose>
					<when test='auth_01.equals("true")'>
					    authrt_cd = 'S01'
					    <if test='auth_02.equals("true")'>
					    	or authrt_cd = 'S02'
					    </if>
					    <if test='auth_03.equals("true")'>
					    	or authrt_cd = 'S04'
					    </if>
					    <if test='auth_04.equals("true")'>
					    	or authrt_cd = 'S05'
					    </if>
					</when>
					<when test='auth_02.equals("true")'>
					    authrt_cd = 'S02'
					    <if test='auth_03.equals("true")'>
					    	or authrt_cd = 'S04'
					    </if>
					</when>
					<when test='auth_03.equals("true")'>
					    authrt_cd = 'S04'
					    <if test='auth_04.equals("true")'>
					    	or authrt_cd = 'S05'
					    </if>
					</when>
					<when test='auth_04.equals("true")'>
					    authrt_cd = 'S05'
					</when>
				</choose>
			)
			</if>
			<if test='crno != "" and crno != null'>
				and crno = #{crno}
			</if>
		)AS T2
		WHERE 1=1
		<if test='api.equals("true")'>
			and api = 'Y'
		</if>
		ORDER BY rn asc
	)AS T
    </sql>
    
    
    <!-- 개별 수신자목록 그리드 sql -->
    <sql id="ReceiverListSql">
    (
    select
		row_number() over(
		order by T1.co_nm desc) rn
				,
		T1.*
				,
		case
			        when user_sn in (
			select
				user_sn
			from
				dqvs.dvs_cmm_mt_sso) then 'sso'
			when user_sn in (
			select
				user_sn
			from
				dqvs.dvs_cmm_mt_onepass) then 'onepass'
			else '-'
		end as source_table,
			    case
					when user_sn in (
			select
				user_sn
			from
				dqvs.dvs_api_mt_key) then 'Y'
			else 'N'
		end as api
	from
		(
		select
			*
		from
			(
			select 
				Tuser.user_sn
				, coalesce(Tsso.user_id,
				Tone."ci",
				'-') as user_id
				, coalesce(Tsso.user_nm,
				Tone.user_nm,
				'-') as user_nm
				,Tuser.authrt_cd
				,(
				select
					authrt_nm
				from
					dqvs.dvs_cmm_mt_auth
				where
					authrt_cd = Tuser.authrt_cd)
				, coalesce((
				select
					case
						when drma.co_nm1 is not null then drma.co_nm1
						when drma.co_nm2 is not null then drma.co_nm2
						else null
					end as co_nm
				from
					(
					select
						co_nm as co_nm1,
						null as co_nm2
					from
						dqvs.dvs_rac_mt_agency Tagency
					where
						bzmn_sn = Tuser.bzmn_sn
				union all
					select
						null as co_nm1,
						co_nm as co_nm2
					from
						dqvs.dvs_rac_mt_request
					where
						bzmn_sn = Tuser.bzmn_sn) drma
				limit 1),
				'-') as co_nm,
					case
						when acnt_stts_cd = '1' then (
					select
						cd_nm
					from
						dqvs.dvs_cmm_mt_code
					where
						cd_group = 'aprv_stts_cd'
						and cd = Tuser.aprv_stts_cd)
					else (
					select
						cd_nm
					from
						dqvs.dvs_cmm_mt_code
					where
						cd_group = 'acnt_stts_cd'
						and cd = acnt_stts_cd)
				end as stts_cd
				, coalesce(
				NULLIF(TRIM(dqvs.pca_decrypt(Tuser.assi_telno,
				'150')), ''),
				NULLIF(TRIM(dqvs.pca_decrypt(Tsso.mbl_telno,
				'150')), ''),
				NULLIF(TRIM(dqvs.pca_decrypt(Tone.mbl_telno,
				'150')), ''),
				NULLIF(TRIM(dqvs.pca_decrypt(Tagency.telno,
				'150')), ''),
				'-') as telno
				, COALESCE(nullif(Tuser.cmptnc_zone_cd,''),nullif(Tagency.reg_cmptnc_cd,'')) as cmptnc_zone_cd
				, ctpv_nm
				, sgg_nm
			from
				dqvs.dvs_cmm_mt_user Tuser
			left join dqvs.dvs_cmm_mt_sso Tsso
			on
				Tuser.user_sn = Tsso.user_sn
			left join dqvs.dvs_cmm_mt_onepass Tone 
			on
				Tsso.user_sn = Tone.user_sn
			left join dqvs.dvs_rac_mt_agency Tagency
			on
				Tuser.bzmn_sn = Tagency.bzmn_sn
			left join (
				select
					stdg_cd,
					ctpv_nm,
					sgg_nm
				from
					dqvs.dvs_cmm_mt_area)g
			on
				Tuser.cmptnc_zone_cd = g.stdg_cd or Tagency.reg_cmptnc_cd = g.stdg_cd
			where
				Tuser.authrt_cd in ('S01', 'S02', 'S03', 'S04', 'S05', 'G01')
				) T3
		where
			user_sn in (
				select
					user_sn
				from
					dqvs.dvs_cmm_mt_sso)
			or user_sn in (
				select
					user_sn
				from
					dqvs.dvs_cmm_mt_onepass)
			)as T1
	where
		1 = 1
		and telno NOT IN ('', '-')
		and user_nm NOT IN ('', '-')
		and T1.stts_cd != '삭제'
		<if test="cmptnc_zone_cd != '' and cmptnc_zone_cd != null">
			and T1.cmptnc_zone_cd like #{cmptnc_zone_cd} || '%'
		</if>
		<if test='search_other_condition == "user_id"'>
			and T1.user_id like '%' || #{search_wrd} || '%'
		</if>
		<if test='search_other_condition == "user_nm"'>
			and T1.user_nm like '%' || #{search_wrd} || '%'
		</if>
		<if test='search_other_condition == "co_nm"'>
			and T1.co_nm like '%' || #{search_wrd} || '%'
		</if>
		<if test='search_other_condition == "telno"'>
			and T1.telno like '%' || #{search_wrd} || '%'
		</if>
		<if test='stts_cd != null and stts_cd != ""'>
			and T1.stts_cd = #{stts_cd}
		</if>
		<if test='authrt_cd != null and authrt_cd != ""'>
			and T1.authrt_cd = #{authrt_cd}
		</if>
		<if test='receiver_except_tel.equals("true")'>
			and telno like '01%'
		</if>
		order by rn asc
	)as T2
    </sql>
    
    
    <!-- 개별 발송 그리드 sql -->
    <sql id="IndivReceiverListSql">
    (
	select
		row_number() over(
		order by T1.co_nm desc) rn
		, T1.*
		, case
        when user_sn in (
			select
				user_sn
			from
				dqvs.dvs_cmm_mt_sso) then 'sso'
		when user_sn in (
			select
				user_sn
			from
				dqvs.dvs_cmm_mt_onepass) then 'onepass'
			else '-'
		end as source_table,
	    case
		when user_sn in (
			select
				user_sn
			from
				dqvs.dvs_api_mt_key) then 'Y'
		else 'N'
		end as api
	from
		(
		select
			*
		from
			(
			select 
				Tuser.user_sn
				, coalesce(Tsso.user_id,
				Tone."ci",
				'-') as user_id
				, coalesce(Tsso.user_nm,
				Tone.user_nm,
				'-') as user_nm
				, Tuser.authrt_cd
				, (
				select
					authrt_nm
				from
					dqvs.dvs_cmm_mt_auth
				where
					authrt_cd = Tuser.authrt_cd)
				, coalesce((
				select
					case
						when drma.co_nm1 is not null then drma.co_nm1
						when drma.co_nm2 is not null then drma.co_nm2
						else null
					end as co_nm
				from
					(
					select
						co_nm as co_nm1,
						null as co_nm2
					from
						dqvs.dvs_rac_mt_agency Tagency
					where
						bzmn_sn = Tuser.bzmn_sn
				union all
					select
						null as co_nm1,
						co_nm as co_nm2
					from
						dqvs.dvs_rac_mt_request
					where
						bzmn_sn = Tuser.bzmn_sn) drma
				limit 1),
				'-') as co_nm
				, case
					when acnt_stts_cd = '1' then (
					select
						cd_nm
					from
						dqvs.dvs_cmm_mt_code
					where
						cd_group = 'aprv_stts_cd'
						and cd = Tuser.aprv_stts_cd)
					else (
					select
						cd_nm
					from
						dqvs.dvs_cmm_mt_code
					where
						cd_group = 'acnt_stts_cd'
						and cd = acnt_stts_cd)
				end as stts_cd
				, coalesce(
				NULLIF(TRIM(dqvs.pca_decrypt(Tuser.assi_telno,
				'150')), ''),
				NULLIF(TRIM(dqvs.pca_decrypt(Tsso.mbl_telno,
				'150')), ''),
				NULLIF(TRIM(dqvs.pca_decrypt(Tone.mbl_telno,
				'150')), ''),
				NULLIF(TRIM(dqvs.pca_decrypt(Tagency.telno,
				'150')), ''),
				'-') as telno
				, COALESCE(nullif(Tuser.cmptnc_zone_cd,''),nullif(Tagency.reg_cmptnc_cd,'')) as cmptnc_zone_cd
				, ctpv_nm
				, sgg_nm
			from
				dqvs.dvs_cmm_mt_user Tuser
			left join dqvs.dvs_cmm_mt_sso Tsso
					on
				Tuser.user_sn = Tsso.user_sn
			left join dqvs.dvs_cmm_mt_onepass Tone on
				Tsso.user_sn = Tone.user_sn
			left join dqvs.dvs_rac_mt_agency Tagency
					on
				Tuser.bzmn_sn = Tagency.bzmn_sn
			left join (
				select
					stdg_cd,
					ctpv_nm,
					sgg_nm
				from
					dqvs.dvs_cmm_mt_area)g
			on
				Tuser.cmptnc_zone_cd = g.stdg_cd or Tagency.reg_cmptnc_cd = g.stdg_cd
			where
				Tuser.authrt_cd in ('S01', 'S02', 'S03', 'S04', 'S05', 'G01')
				) T3
		where
			1 = 1
			and telno NOT IN ('', '-')
			and user_nm NOT IN ('', '-')
			and user_sn in (
			select
				unnest(string_to_array(#{user_sn},
				',')::numeric[])
				)
			)as T1
	where
		1 = 1
	order by
		rn asc
		)as T2
    </sql>

	<!-- 문자발송이력 그리드 -->
	<select id="SmsSendInfo" resultType="map">
		SELECT *
    	FROM
			<include refid="SmsSendInfoSql" />
		<if test="take != '' and take != null">
			WHERE T2.rn <![CDATA[<=]]> (CAST(#{take} AS INTEGER) + CAST(#{skip} AS INTEGER))
		</if>
		<if test="skip != '' and skip != null">
			AND T2.rn <![CDATA[>]]> CAST(#{skip} AS INTEGER)
		</if>
	</select>

	<select id="SmsSendInfoCnt" resultType="int">
		SELECT
			COUNT(*)
		FROM
			<include refid="SmsSendInfoSql" />
	</select>

	<!-- 개별 수신자 목록 그리드 -->
	<select id="ReceiverList" resultType="map">
		SELECT T2.*
    	FROM
			<include refid="ReceiverListSql" />
		<if test="take != '' and take != null">
			WHERE T2.rn <![CDATA[<=]]> (CAST(#{take} AS INTEGER) + CAST(#{skip} AS INTEGER))
		</if>
		<if test="skip != '' and skip != null">
			AND T2.rn <![CDATA[>]]> CAST(#{skip} AS INTEGER)
		</if>
	</select>
	
	<select id="ReceiverListCnt" resultType="int">
		SELECT
			COUNT(*)
		FROM
			<include refid="ReceiverListSql" />
	</select>
	
	
	<!-- 개별 발송 그리드 -->
	<select id="IndivReceiverList" resultType="map">
		SELECT T2.*
    	FROM
			<include refid="IndivReceiverListSql" />
		<if test="take != '' and take != null">
			WHERE T2.rn <![CDATA[<=]]> (CAST(#{take} AS INTEGER) + CAST(#{skip} AS INTEGER))
		</if>
		<if test="skip != '' and skip != null">
			AND T2.rn <![CDATA[>]]> CAST(#{skip} AS INTEGER)
		</if>
	</select>
	
	<select id="IndivReceiverListCnt" resultType="int">
		SELECT
			COUNT(*)
    	FROM
			<include refid="IndivReceiverListSql" />
	</select>
	
	<!-- 그룹 발송 그리드 -->
	<select id="GroupReceiverList" resultType="map">
		SELECT T.*
    	FROM
			<include refid="GroupReceiverListSql" />
		<if test="take != '' and take != null">
			WHERE T.rn <![CDATA[<=]]> (CAST(#{take} AS INTEGER) + CAST(#{skip} AS INTEGER))
		</if>
		<if test="skip != '' and skip != null">
			AND T.rn <![CDATA[>]]> CAST(#{skip} AS INTEGER)
		</if>	
	</select>
	
	<select id="GroupReceiverListCnt" resultType="int">
		SELECT
			COUNT(*)
		FROM
			<include refid="GroupReceiverListSql" />
	</select>
	
	<!-- 문자발송 inno_tran -->
	<insert id="insertSendMsg" parameterType="paraMap">
      /*SMS 메세지 등록*/
		INSERT INTO dqvs.inno_tran (
				MSG_ID
				, SCHEDULE_TYPE
				, SUBJECT
				, SEND_DATE
				, NOW_DATE
				, CALLBACK
				, DEST_COUNT
				, DEST_INFO
				, MSG
				, SYSTEM_MSG_ID
				, SEND_STATUS
		) VALUES (
				nextval('dqvs.seq_inno_tran')
				<if test='send_date == null or send_date == ""'>
					, 0
				</if>
				<if test='send_date != null and send_date != ""'>
					, 1
				</if>
				, NULL
				<if test='send_date == null or send_date == ""'>
					, TO_CHAR(now(), 'YYYYMMDDHH24MISS')
				</if>
				<if test='send_date != null and send_date != ""'>
					, #{send_date}
				</if>
				, TO_CHAR(now(), 'YYYYMMDDHH24MISS')
				, '0544597565'
				, #{dest_count}
				, #{dest_info}
				, #{msg}
				, NULL
				, 0
		)
	</insert>
	
	
	
	<!-- 문자발송이력 -->
	<insert id="insertSendMsgList" parameterType="paraMap">
        /*발송이력 등록*/
		INSERT INTO dqvs.dvs_cmm_hs_sms_send (
				sndng_sn
				, cn
				, rcvr
				, rcvr_telno
				, rsvt_yn
				, sndng_rsvt_dt
				, sndng_dt
				, reg_dt
				, reg_ip
				, sndr_sn
		) VALUES (
				nextval('dqvs.seq_cmm_hs_sms_send')
				, #{msg}
				, #{rcvr}
				, dqvs.pca_encrypt(#{rcvr_telno}, '150')
				<if test='send_date == null or send_date == ""'>
					, 0
				</if>
				<if test='send_date != null and send_date != ""'>
					, 1
				</if>
				<if test='send_date == null or send_date == ""'>
					, now()::timestamp
				</if>
				<if test='send_date != null and send_date != ""'>
					, #{sndng_rsvt_dt}::timestamp
				</if>
				, now()::timestamp
				, now()::timestamp
				, #{userIp}
				, #{userSn}::numeric
		)
	</insert>
	
</mapper>