<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sys.inspectionHist">
	
	<!-- 회사명 자동 검색 -->
	<select id="AgencyList" resultType="resultMap">
		select
			bzmn_sn,
			co_nm
		from
			dqvs.dvs_rac_mt_agency
		where 1=1
		and bsn_stts_cd = '0'
		<if test="userCmptncZoneCd != '' and userCmptncZoneCd != null">
			and reg_cmptnc_cd like #{userCmptncZoneCd} || '%'
		</if>
    </select>
    
    <!-- 회사 정보 검색 -->
	<select id="AgencyInfo" resultType="resultMap">
		select
			bzmn_sn
			, co_nm
			, rprsv_nm
			, brno
			, bsn_stts_mdfcn_dt
			, dqvs.pca_decrypt(telno,
			'150') as agency_telno
			, CONCAT( (
			select
					ctpv_nm
			from
					dqvs.dvs_cmm_mt_area
			where
					stdg_cd = reg_cmptnc_cd),
				' ',
				(
			select
					sgg_nm
			from
					dqvs.dvs_cmm_mt_area
			where
					stdg_cd = reg_cmptnc_cd)) jurisdiction
			, (
			select
				cd.cd_nm
			from
				dqvs.dvs_cmm_mt_code cd
			where
				cd.cd_group = 'bsn_stts_cd'
				and cd.cd = bsn_stts_cd) bsn_stts_nm
		from
			dqvs.dvs_rac_mt_agency
		where
			bzmn_sn = #{bzmnSn}
    </select>
	
	
	<!-- 검색/등록팝업 옵션 - 시도(전체) -->
	<select id="CtpvNm" resultType="map">
	/* 시도(전체) */
        SELECT DISTINCT LPAD(stdg_cd, 2) ctpv_cd
        	, ctpv_nm
		FROM
			dqvs.dvs_cmm_mt_area
		WHERE mtnabn_yn = 'Y'
		<if test="regCmptncCd != null and regCmptncCd != ''">
			AND stdg_cd = #{regCmptncCd}
		</if>
		ORDER BY ctpv_cd
    </select>

    <!-- 검색/등록팝업 옵션 - 시군구(전체) -->
	<select id="SggNm" resultType="map">
        select distinct
			SUBSTRING(stdg_cd, 3, 3) AS sgg_cd, sgg_nm
		from dqvs.dvs_cmm_mt_area
		where mtnabn_yn = 'Y'
			and sgg_nm != ''
		<if test="ctpvCd != null and ctpvCd != ''">
			and stdg_cd LIKE CONCAT(#{ctpvCd}, '%')
		</if>
		<if test="regCmptncCd != null and regCmptncCd != ''">
			and stdg_cd = #{regCmptncCd}
		</if>
		order by sgg_cd
    </select>
    
    <!-- 검색옵션 - 영업상태(전체) -->
	<select id="BsnStts" resultType="map">
        SELECT cd.cd
        	, cd.cd_nm
		FROM 
			dqvs.dvs_cmm_mt_code cd
		WHERE cd.cd_group = 'bsn_stts_cd'
			AND cd.use_yn != 'N'
		<if test="sttsInsertCont != null and sttsInsertCont != '' and sttsInsertCont == 'sttsDrop'">
			AND cd.cd != '3'
		</if>
		ORDER BY cd.cd
    </select>
    
    <!-- 검색옵션 - 권한(전체) -->
	<select id="selectAuth" resultType="map">
        SELECT cd.cd
        	, cd.cd_nm
		FROM 
			dqvs.dvs_cmm_mt_code cd
		WHERE cd_group = 'offc_type_cd'
			AND use_yn != 'N'
		ORDER BY cd.cd
    </select>
	
	
	<sql id="InspectionHistInfoSql">
		(
		SELECT ROW_NUMBER() OVER(ORDER BY T1.co_nm DESC) rn
		, T1.*
		from(
			select
				inspctn.bzmn_sn
				, inspctn.reg_cmptnc_cd
				, inspctn.exmnr
				, inspctn.exmnr2
				, inspctn.exmnr3
				, inspctn.jbgd
				, inspctn.ogdp
				, dqvs.pca_decrypt(inspctn.telno, '150') as telno
				, inspctn.chck_artcl
				, inspctn.etc_artcl
				, inspctn.chck_cn
				, inspctn.chck_plc
				, inspctn.sign_yn
				, inspctn.rslt
				, inspctn.prcs_yn
				, inspctn.file_atch_sn1
				, inspctn.file_atch_sn2
				, inspctn.file_atch_sn3
				, inspctn.file_atch_sn4
				, agency.brno
				, agency.crno
				, agency.rprsv_nm
				, agency.bsn_stts_cd
				, agency.bzmn_se_cd
				, (select
					cd_nm
				from
					dqvs.dvs_cmm_mt_code
				where
					cd_group = 'bzmn_se_cd'
					and cd = bzmn_se_cd) as bzmn_se_nm
				, agency.co_nm
				, agency.road_nm_addr
				, (
				select
					cd.cd_nm
				from
					dqvs.dvs_cmm_mt_code cd
				where
					cd.cd_group = 'bsn_stts_cd'
					and cd.cd = agency.bsn_stts_cd) bsn_stts_nm
				, agency.bsn_stts_mdfcn_dt
				, dqvs.pca_decrypt(agency.telno, '150') as agency_telno
				, CONCAT( (
					select
						ctpv_nm
					from
						dqvs.dvs_cmm_mt_area
					where
						stdg_cd = agency.reg_cmptnc_cd),
					' ',
					(
					select
						sgg_nm
					from
						dqvs.dvs_cmm_mt_area
					where
						stdg_cd = agency.reg_cmptnc_cd)) jurisdiction
				,(
				select
					atch_file_nm
				from
					dqvs.dvs_cmm_mt_file
				where
					file_sn = inspctn.file_atch_sn1) as file_atch_nm1,
				(
				select
					atch_file_nm
				from
					dqvs.dvs_cmm_mt_file
				where
					file_sn = inspctn.file_atch_sn2) as file_atch_nm2,
				(
				select
					atch_file_nm
				from
					dqvs.dvs_cmm_mt_file
				where
					file_sn = inspctn.file_atch_sn3) as file_atch_nm3,
				(
				select
					atch_file_nm
				from
					dqvs.dvs_cmm_mt_file
				where
					file_sn = inspctn.file_atch_sn4) as file_atch_nm4
			from dqvs.dvs_spv_hs_inspctn inspctn
			left join dqvs.dvs_rac_mt_agency agency on agency.bzmn_sn = inspctn.bzmn_sn
			) as T1
			WHERE 1 = 1
			and T1.prcs_yn != 'Y'
			<if test="cmptncZoneCd != '' and cmptncZoneCd != null">
				and T1.reg_cmptnc_cd like #{cmptncZoneCd} || '%'
			</if>
			<if test='bzmnSeCd != "" and bzmnSeCd != null'>
				AND T1.bzmn_se_cd = #{bzmnSeCd}
			</if>
			<if test='bsnSttsCd != "" and bsnSttsCd != null'>
				AND T1.bsn_stts_cd = #{bsnSttsCd}
			</if> 
			<if test="rslt != null and rslt != ''">
				AND T1.rslt = #{rslt}
			</if>
			ORDER BY rn asc
		)as T2
	</sql>

	<!-- 지도점검이력 그리드 -->
	<select id="InspectionHistInfo" resultType="resultMap">
		SELECT *
    	FROM
			<include refid="InspectionHistInfoSql" />
		<if test="take != '' and take != null">
			WHERE T2.rn <![CDATA[<=]]> (CAST(#{take} AS INTEGER) + CAST(#{skip} AS INTEGER))
		</if>
		<if test="skip != '' and skip != null">
			AND T2.rn <![CDATA[>]]> CAST(#{skip} AS INTEGER)
		</if>
	</select>
	
	<select id="InspectionHistInfoCnt" resultType="int">
		SELECT
			COUNT(*)
		FROM
			<include refid="InspectionHistInfoSql" />
	</select>
	
	<insert id="insertInspectionHist">
			INSERT INTO dqvs.dvs_spv_hs_inspctn
				(bzmn_sn
				, reg_cmptnc_cd
				, exmnr
				, jbgd
				, ogdp
				, telno
				, chck_artcl
				, etc_artcl
				, chck_cn
				, chck_plc
				, sign_yn
				, rslt
				, file_atch_sn1
				, file_atch_sn2
				, file_atch_sn3
				, file_atch_sn4
				)
			SELECT 
				bzmn_sn
				, reg_cmptnc_cd
				, #{exmnr}
				, #{jbgd}
				, #{ogdp}
				, dqvs.pca_encrypt(#{telno}, '150')
				, #{chckArtcl}
				, #{etcArtcl}
				, #{chckCn}
				, #{chckPlc}
				, #{signYn}
				, #{rslt}
				, #{fileAtchSn1}::NUMERIC
				, #{fileAtchSn2}::NUMERIC
				, #{fileAtchSn3}::NUMERIC
				, #{fileAtchSn4}::NUMERIC
			FROM dqvs.dvs_rac_mt_agency
			where bzmn_sn = #{bzmnSn}
	</insert>
	
	<update id="updateInspectionHist">
		update
			dqvs.dvs_spv_hs_inspctn
		set
			reg_cmptnc_cd = #{regCmptncCd},
			exmnr = #{exmnr},
			jbgd = #{jbgd},
			ogdp = #{ogdp},
			telno = dqvs.pca_encrypt(#{telno}, '150'),
			chck_artcl = #{chckArtcl},
			etc_artcl = #{etcArtcl},
			chck_cn = #{chckCn},
			chck_plc = #{chckPlc},
			sign_yn = #{signYn},
			rslt = #{rslt},
			file_atch_sn1 = #{fileAtchSn1}::NUMERIC,
			file_atch_sn2 = #{fileAtchSn2}::NUMERIC,
			file_atch_sn3 = #{fileAtchSn3}::NUMERIC,
			file_atch_sn4 = #{fileAtchSn4}::NUMERIC
		where
			bzmn_sn = #{bzmnSn}
	</update>
	
	<update id="updateFile">
		update
			dqvs.dvs_spv_hs_inspctn
		set
			file_atch_sn1 = #{fileAtchSn1}::NUMERIC
		where
			bzmn_sn = #{bzmnSn}
	</update>
	
	<update id="updateDeleteYn">
		UPDATE dqvs.dvs_spv_hs_inspctn
		SET prcs_yn = 'Y'
		WHERE bzmn_sn = #{bzmnSn}
	</update>

</mapper>