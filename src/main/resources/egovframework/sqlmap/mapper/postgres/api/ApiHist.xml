<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="api.apiHist">

		

		<sql id = "listViewWithDev">
		 (
		    SELECT 
		        CONCAT(drma1.co_nm, '(', T1.S4Id, ')') AS rq,
		        CONCAT(
		            COALESCE(drma2.co_nm, drma1.co_nm), 
		            '(', COALESCE(T1.S1Id, T1.S4Id), ')'
		        ) AS orq,
		        T1.api_nm,
		        T1.dmnd_dt,
		        T1.rslt_msg,
		        T1.dmnd_cnt,
		        T1.dln,
		        T1.req_hr
		    FROM (
		        SELECT
		            dami.api_nm,
		            dahr.dmnd_dt,
		            COALESCE(dcms.sso_user_id, dcms.onepass_di) AS S4Id,
		            dcms.bzmn_sn AS S4BZSN,
		            dahr.rqstr_sn,
		            COALESCE(dcms2.sso_user_id, dcms2.onepass_di) AS S1Id,
		            dcms2.bzmn_sn AS S1BZSN,
		            dcmc.cd_expln AS rslt_msg,
		            dahr.dmnd_cnt,
                	dahr.dln,
		            dahr.req_hr
		        FROM dqvs.dvs_api_hs_req_dev AS dahr
		        LEFT JOIN dqvs.dvs_api_mt_info AS dami ON dami.api_sn = dahr.api_sn
		        LEFT JOIN dqvs.dvs_cmm_mt_code AS dcmc ON dcmc.cd = dahr.dmnd_rslt_cd
		        LEFT JOIN dqvs.v_intg_user_admin_info AS dcms ON dcms.user_sn = dahr.user_sn
		        LEFT JOIN dqvs.v_intg_user_admin_info AS dcms2 ON dcms2.user_sn = dahr.rqstr_sn
		        WHERE 
						<choose>	
							<when test="AuthCd == 'K01' or AuthCd == 'Z01' or AuthCd == 'D01'">
<!-- 								dahr.dmnd_dt <![CDATA[>=]]> to_timestamp(#{startPicker02}, 'yyyy-mm-dd hh24:mi') AND dahr.dmnd_dt <![CDATA[<=]]> to_timestamp(#{endPicker02}, 'yyyy-mm-dd hh24:mi') -->
				        	   	dahr.dmnd_dt <![CDATA[>=]]> #{startPicker02}::TIMESTAMP and dahr.dmnd_dt <![CDATA[<=]]> #{endPicker02}::DATE + '23:59:59'::INTERVAL
					        	<if test = "searchSttsCd != ''">
									 and dahr.api_sn = #{searchSttsCd}::numeric 
								</if>
								<if test="detailYN == 'E1' and detailYN != null and detailYN != ''">
								    and dahr.dmnd_rslt_cd = '200'
								</if>
								<if test="detailYN == 'E2' and detailYN != null and detailYN != ''">
								    and dahr.dmnd_rslt_cd != '200'
								</if>
				        	</when>
				        	<otherwise>
								dahr.user_sn = #{userSn}::numeric  
				        	   	dahr.dmnd_dt <![CDATA[>=]]> #{startPicker02}::TIMESTAMP and dahr.dmnd_dt <![CDATA[<=]]> #{endPicker02}::DATE + '23:59:59'::INTERVAL
					        	<if test = "searchSttsCdAPI != ''">
									 and dahr.api_sn = #{searchSttsCdAPI}::numeric 
								</if>
								<if test="ErrorCd == 'E1' and ErrorCd != null and ErrorCd != ''">
								    and dahr.dmnd_rslt_cd = '200'
								</if>
								<if test="ErrorCd == 'E2' and ErrorCd != null and ErrorCd != ''">
								    and dahr.dmnd_rslt_cd != '200'
								</if>
							</otherwise>
				        </choose>

		        ) AS T1
					    LEFT JOIN dqvs.dvs_rac_mt_agency AS drma1 ON T1.S4BZSN = drma1.bzmn_sn
					    LEFT JOIN dqvs.dvs_rac_mt_agency AS drma2 ON T1.S1BZSN = drma2.bzmn_sn
					) as JJ1
		</sql>
<sql id="listViewWithApi">
    SELECT
        dami.api_nm,
        dahr.dmnd_dt,
        COALESCE(dcms.sso_user_id, dcms.onepass_di) AS S4Id,
        dcms.bzmn_sn AS S4BZSN,
        dahr.rqstr_sn,
        COALESCE(dcms2.sso_user_id, dcms2.onepass_di) AS S1Id,
        dcms2.bzmn_sn AS S1BZSN,
        dcmc.cd_expln AS rslt_msg,
        dahr.dmnd_cnt,
        CASE
            WHEN dahr.dln ~ '^[0-9]+$' THEN CONCAT(REPEAT('*', LENGTH(dahr.dln) - 4), SUBSTRING(dahr.dln FROM LENGTH(dahr.dln) - 4))
            ELSE '*******' || SUBSTRING(dqvs.pca_decrypt(dahr.dln, '150'), 8)
        END AS dln2,        
        dahr.req_hr
    FROM dqvs.dvs_api_hs_req AS dahr
    LEFT JOIN dqvs.dvs_api_mt_info AS dami ON dami.api_sn = dahr.api_sn
    LEFT JOIN dqvs.dvs_cmm_mt_code AS dcmc ON dcmc.cd = dahr.dmnd_rslt_cd
    LEFT JOIN dqvs.v_intg_user_admin_info AS dcms ON dcms.user_sn = dahr.user_sn
    LEFT JOIN dqvs.v_intg_user_admin_info AS dcms2 ON dcms2.user_sn = dahr.rqstr_sn
    WHERE 
        dahr.dmnd_ymd BETWEEN #{startPicker02} AND #{endPicker02}
        <if test="searchSttsCd != ''">
            AND dahr.api_sn = #{searchSttsCd}::numeric
        </if>
        <if test="detailYN == 'E1' and detailYN != null and detailYN != ''">
            AND dahr.dmnd_rslt_cd = '200'
        </if>
        <if test="detailYN == 'E2' and detailYN != null and detailYN != ''">
            AND dahr.dmnd_rslt_cd != '200'
        </if>
</sql>

<sql id="listViewWith">
    (SELECT 
        CONCAT(drma1.co_nm, '(', T1.S4Id, ')') AS rq,
        CONCAT(
            COALESCE(drma2.co_nm, drma1.co_nm),
            '(', COALESCE(T1.S1Id, T1.S4Id), ')'
        ) AS orq,
        T1.api_nm,
        T1.dmnd_dt,
        T1.rslt_msg,
        T1.dmnd_cnt,
        T1.dln2,
        T1.req_hr
    FROM (
        <include refid="listViewWithApi" />
    ) AS T1
    LEFT JOIN dqvs.dvs_rac_mt_agency AS drma1 ON T1.S4BZSN = drma1.bzmn_sn
    LEFT JOIN dqvs.dvs_rac_mt_agency AS drma2 ON T1.S1BZSN = drma2.bzmn_sn
    ) as JJ1
</sql>

<select id="listViewapiHist" parameterType="paraMap" resultType="resultMap"> 
    SELECT *
    FROM (
        SELECT 
            ROW_NUMBER() OVER (ORDER BY JJ1.dmnd_dt DESC) AS rn,
            JJ1.*
        FROM <include refid="listViewWith" />
        WHERE 1 = 1
            <if test="searchSttsCd2 == 'Ruser'">
                AND orq LIKE '%' || LOWER(#{searchReq}) || '%'
            </if>
            <if test="searchSttsCd2 == 'user'">
                AND rq LIKE '%' || LOWER(#{searchReq}) || '%'
            </if>
    ) AS t
    <if test="take != '' and take != null">
        WHERE RN <![CDATA[<=]]> (#{page} * #{take})
    </if>
    <if test="skip != '' and skip != null">
        AND RN <![CDATA[>]]> #{skip}
    </if>
    ORDER BY rn
</select>

   		
   <select id="listViewapiHistCnt" parameterType="paraMap" resultType="int">
		    SELECT 
		        count(JJ1.*)
		    FROM <include refid="listViewWith" />
		    WHERE 1 = 1
				<if test = "searchSttsCd2 == 'Ruser'">
					 and orq LIKE '%' || LOWER(#{searchReq}) || '%'
				</if>
				<if test = "searchSttsCd2 == 'user'">
					 and rq LIKE '%' || LOWER(#{searchReq}) || '%'
				</if>
    </select>
    
    <select id="apiSttsViewCnt" resultType="int">
		select
				count(*)
			from
				(
					SELECT
		   		    count(dahr.stts_cd),
				    CASE
				        WHEN dahr.stts_cd ='1' THEN '신청'
				        WHEN dahr.stts_cd = '2' THEN '활용'
				        WHEN dahr.stts_cd = '3' THEN '반려'
				        ELSE '중지'
				    END AS status
				FROM
				    dqvs.dvs_api_mt_stts dahr
				JOIN dqvs.dvs_api_mt_info dami ON dahr.api_sn = dami.api_sn
				WHERE
				    dahr.user_sn = #{UserSn}::numeric
				    AND dahr.dmnd_dt BETWEEN TO_DATE(#{startPicker02}, 'yyyy-mm-dd') AND TO_DATE(#{endPicker02}, 'yyyy-mm-dd')+1
			        	<if test='searchSttsCd2 == "신청"'>
				            AND dahr.stts_cd = '1'
				        </if>
				        <if test='searchSttsCd2 == "활용"'>
				            AND dahr.stts_cd = '2'
				        </if>
				        <if test='searchSttsCd2 == "반려"'>
				            AND dahr.stts_cd = '3'
				        </if>
				        <if test='searchSttsCd2 == "중지"'>
				            AND dahr.stts_cd = '4'
				        </if>
				group by dahr.stts_cd 
			) a
    </select>	
	<!-- 기간 연장 -->
    
    	<select id="listViewapiDevHist" parameterType="paraMap" resultType="resultMap">
		SELECT *,
		    CASE
		        WHEN t.dln ~ '^[0-9]+$' THEN CONCAT(REPEAT('*', LENGTH(t.dln) - 4), SUBSTRING(t.dln FROM LENGTH(t.dln) - 4))
		        ELSE '*******' || SUBSTRING(dqvs.pca_decrypt(t.dln, '150'), 8)
		    END AS dln2	
		    FROM (
		    SELECT 
		        ROW_NUMBER() OVER (ORDER BY JJ1.dmnd_dt DESC) AS rn,
		        JJ1.*
		    FROM <include refid="listViewWithDev" />
		    WHERE 1 = 1
				<if test = "searchSttsCd2 == 'Ruser'">
					 and orq LIKE '%' || LOWER(#{searchReq}) || '%'
				</if>
				<if test = "searchSttsCd2 == 'user'">
					 and rq LIKE '%' || LOWER(#{searchReq}) || '%'
				</if>
		    ) AS t
		        <if test="take != '' and take != null">
		          	WHERE RN <![CDATA[<=]]> (#{page} * #{take})
		        </if>
		        <if test="skip != '' and skip != null">
		        	AND RN <![CDATA[>]]> #{skip}
		        </if>
		ORDER BY rn
   </select>
   <select id="listViewapiHistDevCnt" parameterType="paraMap" resultType="int">
	    SELECT 
	        count(JJ1.*)
	    FROM <include refid="listViewWithDev" />
	    WHERE 1 = 1
			<if test = "searchSttsCd2 == 'Ruser'">
				 and orq LIKE '%' || LOWER(#{searchReq}) || '%'
			</if>
			<if test = "searchSttsCd2 == 'user'">
				 and rq LIKE '%' || LOWER(#{searchReq}) || '%'
			</if>
    </select>
    <select id="ckapiList" resultType="resultMap">
        select api_nm, api_sn
        from dqvs.dvs_api_mt_info
        order by api_sn asc
    </select>
</mapper>