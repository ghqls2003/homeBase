<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="stts.allTotStts">
	
	<!-- 데이터 검증 필요 -->
	<!-- 대여사업자 종합 현황 -->
	<select id="agencyTimeYearGrid" parameterType="paraMap" resultType="resultMap">
	/* 대여사업자 */
	SELECT ROW_NUMBER() OVER(ORDER BY main.date_ym DESC) sn
		, main.*
	FROM
		(
		SELECT t3.dt_year date_ym
			, TO_CHAR(SUM(t3.set_agency) OVER (ORDER BY t3.dt_year DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING), 'FM999,999,999') tot
			, TO_CHAR(t3.new_agency, 'FM999,999,999') new_agency
			, TO_CHAR(t3.stts_close, 'FM999,999,999') stts_close
			, TO_CHAR(SUM(t3.stts_normal) OVER (ORDER BY t3.dt_year DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING), 'FM999,999,999') stts_normal
			, TO_CHAR(SUM(t3.stts_rest) OVER (ORDER BY t3.dt_year DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING), 'FM999,999,999') stts_rest
			, TO_CHAR(SUM(t3.stts_break) OVER (ORDER BY t3.dt_year DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING), 'FM999,999,999') stts_break
			, TO_CHAR(SUM(t3.stts_etc) OVER (ORDER BY t3.dt_year DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING), 'FM999,999,999') stts_etc
			, TO_CHAR(SUM(t3.vhcl_count) OVER (ORDER BY t3.dt_year DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING), 'FM999,999,999') vhcl_count
			, TO_CHAR(SUM(t3.vhcl_count_close_minu) OVER (ORDER BY t3.dt_year DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING), 'FM999,999,999') vhcl_count_close_minu
		FROM
			(
			SELECT t2.*
				, t2.stts_normal+t2.stts_rest+t2.stts_break+t2.stts_etc set_agency
			FROM 
				(
				SELECT t1.dt_year
					, SUM(t1.new_agency) new_agency
					, SUM(t1.stts_normal) stts_normal
					, SUM(t1.stts_rest) stts_rest
					, SUM(t1.stts_close) stts_close
					, SUM(t1.stts_break) stts_break
					, SUM(t1.stts_etc) stts_etc
					, SUM(t1.agency_count) agency_count
					, SUM(t1.vhcl_count) vhcl_count
					, SUM(t1.vhcl_count-t1.vhcl_close) vhcl_count_close_minu
				FROM
					(
					SELECT COALESCE((CASE WHEN mstr.biz_strt_day = '' OR mstr.biz_strt_day ISNULL THEN NULL ELSE TO_CHAR(TO_TIMESTAMP(mstr.biz_strt_day, 'YYYYMMDD'), 'YYYY') END), 
									(CASE WHEN mstr.bsn_stts_mdfcn_dt = '' OR mstr.bsn_stts_mdfcn_dt ISNULL THEN NULL ELSE TO_CHAR(TO_TIMESTAMP(mstr.bsn_stts_mdfcn_dt, 'YYYYMMDD'), 'YYYY') END), NULL) dt_year
						, CASE WHEN mstr.biz_strt_day = '' OR mstr.biz_strt_day ISNULL THEN NULL ELSE 1 END new_agency
						, CASE mstr.bsn_stts_cd WHEN '0' THEN 1 ELSE 0 END stts_normal
						, CASE mstr.bsn_stts_cd WHEN '1' THEN 1 ELSE 0 END stts_rest
						, CASE mstr.bsn_stts_cd WHEN '3' THEN 1 ELSE 0 END stts_close
						, CASE mstr.bsn_stts_cd WHEN '4' THEN 1 ELSE 0 END stts_break
						, CASE mstr.bsn_stts_cd WHEN '9' THEN 1 ELSE 0 END stts_etc
						, mstr.vhcl_reg_noh vhcl_count
						, CASE WHEN mstr.bsn_stts_cd = '3' THEN mstr.vhcl_reg_noh ELSE 0 END vhcl_close
						, 1 agency_count
					FROM 
						dqvs.dvs_rac_mt_agency mstr
					WHERE 1=1
					<if test="sggCd != null and sggCd != ''">
						AND LEFT(mstr.reg_cmptnc_cd, 5) = LEFT(#{sggCd}, 5)
					</if>
					) AS t1
				GROUP BY t1.dt_year
				) AS t2
			) AS t3
		) AS main
	WHERE main.date_ym::NUMERIC <![CDATA[ <= ]]> #{yearStand}::NUMERIC
	</select>
	
	<!-- 대여사업자 정보갱신이력 -->
	<select id="agencyHsGrid" parameterType="paraMap" resultType="int">
	/* 정보갱신이력 */
	SELECT COUNT(hs.*) hs_count
	FROM
		dqvs.dvs_rac_hs_agency hs
	WHERE TO_CHAR(hs.reg_dt, 'YYYY')::NUMERIC <![CDATA[ = ]]> #{yearStand}::NUMERIC
	<if test="sggCd != null and sggCd != ''">
		AND LEFT(hs.reg_cmptnc_cd, 5) = LEFT(#{sggCd}, 5)
	</if>
	</select>
	
	<!-- 면허조회 결과 -->
	<select id="verfResult" parameterType="paraMap" resultType="resultMap">
	/* 면허조회 결과 */	
		SELECT t2.*
		FROM 
			(
			SELECT t1.vrfc_dt
				, COALESCE(SUM(t1.s1), 0) s1
				, COALESCE(SUM(t1.f1), 0) f1
				, COALESCE(SUM(t1.s2), 0) s2
				, COALESCE(SUM(t1.f2), 0) f2
				, COALESCE(SUM(t1.s3), 0) s3
				, COALESCE(SUM(t1.f3), 0) f3
				, COALESCE(SUM(t1.s4), 0) s4
				, COALESCE(SUM(t1.f4), 0) f4
				, COALESCE(SUM(t1.s5), 0) s5
				, COALESCE(SUM(t1.f5), 0) f5
			FROM
				(
				SELECT TO_CHAR(verf.vrfc_dmnd_dt, 'YYYY') vrfc_dt
					, CASE WHEN verf.vrfc_mthd = '1' AND verf.vrfc_rslt = '1' THEN 1 END s1
					, CASE WHEN verf.vrfc_mthd = '1' AND verf.vrfc_rslt = '2' THEN 1 END f1
					, CASE WHEN verf.vrfc_mthd = '2' AND verf.vrfc_rslt = '1' THEN 1 END s2
					, CASE WHEN verf.vrfc_mthd = '2' AND verf.vrfc_rslt = '2' THEN 1 END f2
					, CASE WHEN verf.vrfc_mthd = '3' AND verf.vrfc_rslt = '1' THEN 1 END s3
					, CASE WHEN verf.vrfc_mthd = '3' AND verf.vrfc_rslt = '2' THEN 1 END f3
					, CASE WHEN verf.vrfc_mthd = '4' AND verf.vrfc_rslt = '1' THEN 1 END s4
					, CASE WHEN verf.vrfc_mthd = '4' AND verf.vrfc_rslt = '2' THEN 1 END f4
					, CASE WHEN verf.vrfc_mthd NOT IN('1', '2', '3', '4') AND verf.vrfc_rslt = '1' THEN 1 END s5
					, CASE WHEN verf.vrfc_mthd NOT IN('1', '2', '3', '4') AND verf.vrfc_rslt = '2' THEN 1 END f5
				FROM 
					dqvs.dvs_dqv_hs_verf verf
				WHERE TO_CHAR(verf.vrfc_dmnd_dt, 'YYYY') = #{yearStand}
				) AS t1
			GROUP BY t1.vrfc_dt
			) AS t2
	</select>
	
	<!-- 지역별 차량 대여 현황(Top5) -->
	<select id="areaRentTop5" parameterType="paraMap" resultType="resultMap">
	/* 지역별 차량 대여 현황(Top5) */
		SELECT ROW_NUMBER() OVER(ORDER BY t2.cnt DESC) sn
			, t2.*
		FROM
			(
			SELECT t1.rent_stts_cd
				, t1.bg_dt
				, t1.end_dt
				, COALESCE(CASE t1.sido WHEN '43' THEN '충북' WHEN '44' THEN '충남' WHEN '52' THEN '전북' WHEN '46' THEN '전남' WHEN '47' THEN '경북' WHEN '48' THEN '경남'
												ELSE (SELECT substring(sd.ctpv_nm, 1, 2) FROM dqvs.dvs_cmm_mt_sd sd WHERE sd.ctpv_cd = substring(t1.sido, 1, 2)) 
												END, '-') sido
				, SUM(t1.cnt) cnt
			FROM
				(
				SELECT rent.rent_no 
					, rent.rent_stts_cd 
					, to_char(rent.rent_bgng_dt, 'YYYY') bg_dt
					, to_char(rent.rent_end_dt, 'YYYY') end_dt
					, substring(rent.sgg_cd, 1, 2) sido
					, 1 cnt
				FROM
					dqvs.dvs_dqv_mt_rent rent
				WHERE rent.rent_stts_cd = '2'
					AND NOT rent.sgg_cd ISNULL
					AND rent.sgg_cd != '' 
				) AS t1
			WHERE t1.bg_dt <![CDATA[ = ]]> #{yearStand}
			GROUP BY t1.rent_stts_cd
				, t1.bg_dt
				, t1.end_dt
				, t1.sido
			) AS t2	
		LIMIT 5
	</select>
	
	<!-- 대여사업자별 대여 현황(Top5) -->
	<select id="agencyRentTop5" parameterType="paraMap" resultType="resultMap">
	/* 대여사업자별 차량 대여 현황(Top5) */
		SELECT ROW_NUMBER() OVER(ORDER BY t2.cnt DESC) sn
			, t2.*
		FROM
			(
			SELECT t1.rent_stts_cd
				, t1.bg_dt
				, t1.end_dt
				, COALESCE(t1.co_nm, '-') co_nm
				, SUM(t1.cnt) cnt
			FROM
				(
				SELECT rent.rent_no 
					, rent.rent_stts_cd 
					, TO_CHAR(rent.rent_bgng_dt, 'YYYY') bg_dt
					, TO_CHAR(rent.rent_end_dt, 'YYYY') end_dt
					, LEFT(rent.sgg_cd, 5) sido
					, a.co_nm
					, 1 cnt
				FROM
					dqvs.dvs_dqv_mt_rent rent
				LEFT OUTER JOIN
					dqvs.dvs_rac_hs_agency a
				ON rent.bzmn_sn = a.brno
				WHERE rent.rent_stts_cd = '2'
					AND NOT rent.sgg_cd ISNULL
					AND rent.sgg_cd != ''
				) AS t1
			WHERE t1.bg_dt <![CDATA[ = ]]> #{yearStand}
			<if test="sggCd != null and sggCd != ''">
				AND t1.sido <![CDATA[ = ]]> LEFT(#{sggCd}, 5)
			</if>
			GROUP BY t1.rent_stts_cd
				, t1.bg_dt
				, t1.end_dt
				, t1.co_nm
			) AS t2	
		LIMIT 5
	</select>
	
	<!-- 지역별 차량 결함 현황(Top5) -->
	<select id="areaFlawTop5" parameterType="paraMap" resultType="resultMap">
	/* 지역별 차량 결함 현황(Top5) */
		SELECT ROW_NUMBER() OVER(ORDER BY t2.cnt DESC) sn
			, t2.*
		FROM
			(
			SELECT CASE t1.sido WHEN '43' THEN '충북' WHEN '44' THEN '충남' WHEN '52' THEN '전북' WHEN '46' THEN '전남' WHEN '47' THEN '경북' WHEN '48' THEN '경남'
													ELSE (SELECT substring(sd.ctpv_nm, 1, 2) FROM dqvs.dvs_cmm_mt_sd sd WHERE sd.ctpv_cd = substring(t1.sido, 1, 2)) END sido
				, t1.cnt
			FROM
				(
				SELECT sd.ctpv_cd sido
					, FLOOR(RANDOM()*30+1) cnt 
				FROM 
					dqvs.dvs_cmm_mt_sd sd 
				ORDER BY RANDOM() 
				LIMIT 5
				) AS t1
			) AS t2
	</select>
	
	<!-- 대여사업자별 차량 결함 현황(Top5) -->
	<select id="agencyFlawTop5" parameterType="paraMap" resultType="resultMap">
	/* 대여사업자별 차량 결함 현황(Top5) */
		SELECT ROW_NUMBER() OVER(ORDER BY t2.cnt DESC) sn
			, t2.*
		FROM
			(
			SELECT COALESCE(t1.co_nm, '-') co_nm
				, t1.cnt
			FROM
				(
				SELECT mstr.co_nm
					, FLOOR(RANDOM()*10000+1) cnt 
				FROM 
					dqvs.dvs_rac_mt_agency mstr
				ORDER BY RANDOM() 
				LIMIT 5
				) AS t1
			) AS t2
	</select>
	
	<!-- 지역별 차량 보유 현황(Top5) -->
	<select id="areaHaveTop5" parameterType="paraMap" resultType="resultMap">
	/* 지역별 차량 보유 현황(Top5) */
		SELECT ROW_NUMBER() OVER(ORDER BY t3.cnt DESC) sn
			, t3.cnt
			, COALESCE(t3.sido, '-') sido
		FROM 
			(
			SELECT SUM(vhcl_count_close_minu) cnt
				, t2.sido
			FROM
				(
				SELECT t1.dt_year
					, SUM(t1.vhcl_count-t1.vhcl_close) vhcl_count_close_minu
					, CASE t1.sido WHEN '43' THEN '충북' WHEN '44' THEN '충남' WHEN '52' THEN '전북' WHEN '46' THEN '전남' WHEN '47' THEN '경북' WHEN '48' THEN '경남'
											ELSE (SELECT substring(sd.ctpv_nm, 1, 2) FROM dqvs.dvs_cmm_mt_sd sd WHERE sd.ctpv_cd = substring(t1.sido, 1, 2)) END sido
				FROM
					(
					SELECT COALESCE((CASE WHEN mstr.biz_strt_day = '' OR mstr.biz_strt_day ISNULL THEN NULL ELSE TO_CHAR(TO_TIMESTAMP(mstr.biz_strt_day, 'YYYYMMDD'), 'YYYY') END), 
									(CASE WHEN mstr.bsn_stts_mdfcn_dt = '' OR mstr.bsn_stts_mdfcn_dt ISNULL THEN NULL ELSE TO_CHAR(TO_TIMESTAMP(mstr.bsn_stts_mdfcn_dt, 'YYYYMMDD'), 'YYYY') END), NULL) dt_year
						, mstr.vhcl_reg_noh vhcl_count
						, CASE WHEN mstr.bsn_stts_cd = '3' THEN mstr.vhcl_reg_noh ELSE 0 END vhcl_close
						, SUBSTRING(mstr.sgg_cd, 1, 2) sido
					FROM 
						dqvs.dvs_rac_mt_agency mstr
					) AS t1
				WHERE t1.dt_year <![CDATA[ <= ]]> #{yearStand}
				GROUP BY t1.sido
					, t1.dt_year
				) AS t2
			GROUP BY t2.sido
			) AS t3
		LIMIT 5;
	</select>
	
	<!-- 대여사업자별 차량 보유 현황(Top5) -->
	<select id="agencyHaveTop5" parameterType="paraMap" resultType="resultMap">
	/* 대여사업자별 차량 보유 현황(Top5) */
		SELECT ROW_NUMBER() OVER(ORDER BY t3.cnt DESC) sn
			, COALESCE(t3.co_nm, '-') co_nm
			, t3.cnt
		FROM 
			(
			SELECT COALESCE(SUM(vhcl_count_close_minu), 0) cnt
				, t2.co_nm
			FROM
				(
				SELECT t1.dt_year
					, t1.co_nm
					, SUM(t1.vhcl_count-t1.vhcl_close) vhcl_count_close_minu
				FROM
					(
					SELECT COALESCE((CASE WHEN mstr.biz_strt_day = '' OR mstr.biz_strt_day ISNULL THEN NULL ELSE TO_CHAR(TO_TIMESTAMP(mstr.biz_strt_day, 'YYYYMMDD'), 'YYYY') END), 
									(CASE WHEN mstr.bsn_stts_mdfcn_dt = '' OR mstr.bsn_stts_mdfcn_dt ISNULL THEN NULL ELSE TO_CHAR(TO_TIMESTAMP(mstr.bsn_stts_mdfcn_dt, 'YYYYMMDD'), 'YYYY') END), NULL) dt_year
						, mstr.vhcl_reg_noh vhcl_count
						, CASE WHEN mstr.bsn_stts_cd = '3' THEN mstr.vhcl_reg_noh ELSE 0 END vhcl_close
						, mstr.co_nm
						, LEFT(mstr.reg_cmptnc_cd, 5) reg_cmptnc_cd
					FROM 
						dqvs.dvs_rac_mt_agency mstr
					) AS t1
				WHERE t1.dt_year <![CDATA[ <= ]]> #{yearStand}
				<if test="sggCd != null and sggCd != ''">
					AND t1.reg_cmptnc_cd <![CDATA[ = ]]> LEFT(#{sggCd}::TEXT, 5)
				</if>
				GROUP BY t1.dt_year
					, t1.co_nm
				) AS t2
			GROUP BY t2.co_nm
			) AS t3
		LIMIT 5;
	</select>
	
	<!-- 지역 / 계절별 차량 대여 현황 -->
	<select id="areaSeasonRent" parameterType="paraMap" resultType="resultMap">
	/* 지역 계절별 차량 대여 현황 */
		SELECT CASE sd.ctpv_cd WHEN '43' THEN '충북' WHEN '44' THEN '충남' WHEN '52' THEN '전북' WHEN '46' THEN '전남' WHEN '47' THEN '경북' WHEN '48' THEN '경남'
							   ELSE SUBSTRING(sd.ctpv_nm, 1, 2) END sido
			, COALESCE(SUM(t.spring), 0) spring
			, COALESCE(SUM(t.summer), 0) summer
			, COALESCE(SUM(t.autumn), 0) autumn
			, COALESCE(SUM(t.winter), 0) winter
		FROM 
			dqvs.dvs_cmm_mt_sd sd
		LEFT OUTER JOIN
			(
			SELECT CASE SUBSTRING(rent.sgg_cd, 1, 2) WHEN '45' THEN '52' ELSE SUBSTRING(rent.sgg_cd, 1, 2) END sido
				, CASE WHEN EXTRACT(MONTH FROM rent.rent_bgng_dt) BETWEEN 3 AND 5 THEN 1 ELSE 0 END spring
				, CASE WHEN EXTRACT(MONTH FROM rent.rent_bgng_dt) BETWEEN 6 AND 8 THEN 1 ELSE 0 END summer
				, CASE WHEN EXTRACT(MONTH FROM rent.rent_bgng_dt) BETWEEN 9 AND 11 THEN 1 ELSE 0 END autumn
				, CASE WHEN EXTRACT(MONTH FROM rent.rent_bgng_dt) <![CDATA[ = ]]> 12 OR EXTRACT(MONTH FROM rent.rent_bgng_dt) <![CDATA[ <= ]]> 2 THEN 1 ELSE 0 END winter
			FROM
				dqvs.dvs_dqv_mt_rent rent
			WHERE rent.del_yn = 'N' AND rent.use_yn = 'Y'
				AND rent.rent_stts_cd = '2'
				AND NOT rent.sgg_cd ISNULL AND rent.sgg_cd != ''
				AND EXTRACT(YEAR FROM rent.rent_bgng_dt)::TEXT = #{yearStand}
			) AS t
		ON sd.ctpv_cd = t.sido
		WHERE sd.ctpv_cd != '45'
		GROUP BY sd.ctpv_cd
			, sd.ctpv_nm
	</select>
	
	<!-- 차량 결함정보 그리드 -->
	<select id="carDefectsInfo" parameterType="paraMap" resultType="resultMap">
	/* 차량 결함정보 그리드 */
	SELECT TO_CHAR(d.ocrn_dt, 'YYYY-MM-DD') ocrn_dt 
		, d.defects_sn 
		, CASE d.defects_type_cd WHEN '1' THEN '리콜' WHEN '2' THEN '무상수리' END defects_type_cd 
		, d.prcs_stts_cd 
		, COUNT(d.vin) cnt 
	FROM
		dqvs.dvs_rac_mt_car car
	LEFT OUTER JOIN
		dqvs.dvs_rac_mt_defect d
	ON car.vin = d.vin
	WHERE NOT d.ocrn_dt ISNULL AND TO_CHAR(d.ocrn_dt, 'YYYY')::NUMERIC = #{yearStand}::NUMERIC
	GROUP BY d.defects_sn 
		, TO_CHAR(d.ocrn_dt, 'YYYY-MM-DD')
		, d.defects_type_cd 
		, d.prcs_stts_cd 
	ORDER BY ocrn_dt DESC		
	</select>
</mapper>
