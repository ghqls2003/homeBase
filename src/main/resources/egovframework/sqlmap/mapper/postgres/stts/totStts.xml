<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="stts.totStts">

	<!-- 대여사업자 현황 그리드 -->
	<select id="agencyAreaGrid" parameterType="paraMap" resultType="resultMap">
	/* 대여사업자 현황 그리드 */
		SELECT t2.sd_nm
			, COALESCE(TO_CHAR(t2.stts_normal, 'FM999,999,999'), '-') stts_normal
			, COALESCE(TO_CHAR(t2.accession, 'FM999,999,999'), '-') accession
			, ROUND((t2.accession/t2.stts_normal::NUMERIC)*100, 2) accession_per
			, COALESCE(TO_CHAR(t2.sedan, 'FM999,999,999'), '-') sedan
			, COALESCE(TO_CHAR(t2.van, 'FM999,999,999'), '-') van
			, COALESCE(TO_CHAR(t2.special, 'FM999,999,999'), '-') special
			, t2.sd_cd conn
		FROM 
			(
			SELECT COALESCE(t1.sd_nm, '시도 합계') sd_nm
				, SUM(t1.stts_normal_cnt) stts_normal
				, SUM(t1.accession) accession
				, SUM(t1.sedan) sedan
				, SUM(t1.van) van
				, SUM(special) special
				, t1.sd_cd
			FROM
				(
				SELECT LEFT(mstr.sgg_cd, 2) sd_cd
					, COALESCE((SELECT ctpv_nm FROM dqvs.dvs_cmm_mt_sd WHERE ctpv_cd = LEFT(mstr.sgg_cd, 2)), '-') sd_nm
					, 1 stts_normal_cnt
					, CASE WHEN (SELECT COUNT(*) FROM dqvs.dvs_cmm_mt_user usr WHERE usr.bzmn_sn = mstr.bzmn_sn) = 0 THEN 0 ELSE 1 END accession
					, COALESCE(mstr.car_noh+mstr.elcty_car_noh, 0) sedan
					, COALESCE(mstr.van_noh+mstr.elcty_van_noh, 0) van
					, 0 special
				FROM 
					dqvs.dvs_rac_mt_agency mstr
				WHERE mstr.bsn_stts_cd = '0'
				) AS t1
			GROUP BY ROLLUP((t1.sd_cd, t1.sd_nm))
			) AS t2
		ORDER BY CASE WHEN t2.sd_nm = '시도 합계' THEN 0 ELSE 1 END, t2.sd_cd ASC
	</select>
	
	<!-- 대여사업자 현황 그리드(시군구) -->
	<select id="agencyAreaDetailGrid" parameterType="paraMap" resultType="resultMap">
	/* 대여사업자 현황 그리드(시군구) */
		SELECT t2.sgg_nm
			, COALESCE(TO_CHAR(t2.stts_normal, 'FM999,999,999'), '-') stts_normal
			, COALESCE(TO_CHAR(t2.accession, 'FM999,999,999'), '-') accession
			, ROUND((t2.accession/t2.stts_normal::NUMERIC)*100, 2) accession_per
			, COALESCE(TO_CHAR(t2.sedan, 'FM999,999,999'), '-') sedan
			, COALESCE(TO_CHAR(t2.van, 'FM999,999,999'), '-') van
			, COALESCE(TO_CHAR(t2.special, 'FM999,999,999'), '-') special
			, COALESCE(LEFT(t2.sgg_cd, 2), '-') conn
		FROM 
			(
			SELECT COALESCE(t1.sgg_nm, '합계') sgg_nm
				, SUM(t1.stts_normal_cnt) stts_normal
				, SUM(t1.accession) accession
				, SUM(t1.sedan) sedan
				, SUM(t1.van) van
				, SUM(special) special
				, t1.sgg_cd
			FROM
				(
				SELECT LEFT(mstr.sgg_cd, 5) sgg_cd
					, COALESCE((SELECT sgg_nm FROM dqvs.dvs_cmm_mt_sgg WHERE sgg_cd = LEFT(mstr.sgg_cd, 5)), '-') sgg_nm
					, 1 stts_normal_cnt
					, CASE WHEN (SELECT COUNT(*) FROM dqvs.dvs_cmm_mt_user usr WHERE usr.bzmn_sn = mstr.bzmn_sn) = 0 THEN 0 ELSE 1 END accession
					, COALESCE(mstr.car_noh+mstr.elcty_car_noh, 0) sedan
					, COALESCE(mstr.van_noh+mstr.elcty_van_noh, 0) van
					, 0 special
				FROM 
					dqvs.dvs_rac_mt_agency mstr
				WHERE mstr.bsn_stts_cd = '0'
				) AS t1
			GROUP BY t1.sgg_nm, t1.sgg_cd
			ORDER BY t1.sgg_cd ASC
			) AS t2	
	</select>
	
	<!-- 대여사업자 가입 현황 -->
	<select id="agencyAccessionChart" parameterType="paraMap" resultType="resultMap">
	/* 대여사업자 가입 현황 */	
		SELECT t2.sd_nm
			, COALESCE(t2.stts_normal, 0) stts_normal
		FROM 
			(
			SELECT t1.sd_nm sd_nm
				, SUM(t1.stts_normal_cnt) stts_normal
				, t1.sd_cd
			FROM
				(
				SELECT LEFT(mstr.sgg_cd, 2) sd_cd
					, COALESCE((SELECT ctpv_nm FROM dqvs.dvs_cmm_mt_sd WHERE ctpv_cd = LEFT(mstr.sgg_cd, 2)), '-') sd_nm
					, 1 stts_normal_cnt
				FROM 
					dqvs.dvs_rac_mt_agency mstr
				WHERE mstr.bsn_stts_cd = '0'
				) AS t1
			GROUP BY t1.sd_cd, t1.sd_nm
			) AS t2
		ORDER BY t2.sd_cd
	</select>
</mapper>
