Secure=(function(){var B=sofo.utils||{};var a=sofo.crypto||{};if(!Object.create){Object.create=function(O,M){if(typeof O!=="object"&&typeof O!=="function"){throw new TypeError("Object prototype may only be an Object: "+O);}else{if(O===null){throw new Error("This browser's implementation of Object.create is a shim and doesn't support 'null' as the first argument.");}}if(typeof M!="undefined"){throw new Error("This browser's implementation of Object.create is a shim and doesn't support a second argument.");}function N(){}N.prototype=O;return new N();};}var K={"close_notify":"40000","unexpected_message":"40010","bad_record_mac":"40020","decryption_failed_RESERVED":"40021","record_overflow":"40022","bad_verify_hash":"40023","bad_verify_mac":"40024","decompression_failure":"40030","no_certificate_RESERVED":"40041","bad_certificate":"40042","unsupported_certificate":"40043","certificate_revoked":"40044","certificate_expired":"40045","certificate_unknown":"40046","illegal_parameter":"40047","unknown_ca":"40048","access_denied":"40049","decode_error":"40050","decrypt_error":"40051","unknown_error":"41000","create_keyBlock_failure":"41001","generatorRandom_fail":"41002","unknown_sym_algorithm":"41003","unknown_hash_algorithm":"41004","invalid_keyBlock":"41005","invalid_pem_format":"41006","utf8_decode_fail":"41007","unsupported_protocol_type":"41010"};var u="",n="1.0.0";var s,b,o;var G;var d,I,t,J;var v,f,r;var c={};var m;var A;var q;var p;var e;var i=function(){return{value:"",param:{publicKeyAlg:null,symKeyAlg:null,hashAlg:null},iv:{},macKey:{},encKey:{},server:{iv:{},macKey:{},encKey:{}}};};var g=new i();var w={};var E=function(N,M){return{protocolType:"secure",message:N,hash:M};};var C=function(N,M){return{protocolType:"envelope",message:N,hash:M};};function j(M,N){this.errorCode=K[M];this.errorMsg=M;if(N==null||N==undefined){this.funcCall="";}else{this.funcCall=N;}}j.prototype=Object.create(Error.prototype);j.prototype.constructor=j;function y(T){var R=T.macKey.length;var M=T.encKey.length;var P=T.iv.length;var S,N;try{N=R+M+P;T.macKey.value=B.generatorRandom(R);T.encKey.value=B.generatorRandom(M);T.iv.value=B.generatorRandom(P);S=B.createBuffer(N);var Q=0;B.memcpy(T.macKey.value,0,S,Q,R);Q+=20;B.memcpy(T.encKey.value,0,S,Q,M);Q+=16;B.memcpy(T.iv.value,0,S,Q,P);Q+=16;if(S===undefined||S==null){throw new j("unknown_sym_algorithm");}return S;}catch(O){if(O.errorMsg){throw new j(O.errorMsg,"[envelopeCreateKeyBlock]");}else{throw new j(O.message,"[envelopeCreateKeyBlock]");}}}function D(N){try{switch(N.param.symKeyAlg){case "seedCBC":N.iv.length=16;N.encKey.length=16;break;case "aesCBC":N.iv.length=16;N.encKey.length=16;break;default:throw new j("unknown_sym_algorithm");break;}switch(N.param.hashAlg){case "macWithSHA":N.macKey.length=20;break;default:throw new j("unknown_hash_algorithm");break;}}catch(M){if(M.errorMsg){throw new Error("[AnySign4PC][setCipher] ErrorMsg : "+M.errorMsg+"("+M.errorCode+")");}else{throw M;}}}function h(M,O){if(O===undefined){O=new i();}try{switch(M){case "secure":O.param.publicKeyAlg="RSAES-PKCS1-V1_5";O.param.hashAlg="macWithSHA";O.param.symKeyAlg="seedCBC";break;case "envelope":O.value="RSA_SEED_128_SHA";O.param.hashAlg="macWithSHA";O.param.publicKeyAlg="RSAES-PKCS1-V1_5";O.param.symKeyAlg="aesCBC";break;default:throw new j("unsupported_protocol_type");break;}}catch(N){throw new Error("[AnySign4PC][setAlgorithm] ErrorMsg : "+N.errorMsg+"("+N.errorCode+")");}}var k=function(N,M){var O;try{if(N=="secure"){d=B.generatorRandom(32);if(d===undefined||d==null){throw new j("generatorRandom_fail");}var Q={sid:u,messageType:"client_hello",version:n,random:B.base64Encode(d)};s=B.base64Encode(clientHash.getBytes());O=JSON.stringify(E(Q,s));}else{var Q={sid:"",messageType:"client_hello",version:n};s="";O=JSON.stringify(C(Q,s));}M(O);}catch(P){if(P.errorMsg){throw new Error("[AnySign4PC][clientHello] ErrorMsg : "+P.errorMsg+"("+P.errorCode+")");}else{throw new Error("[AnySign4PC][clientHello][Native] ErrorMsg : "+P.message);}}};function z(R,T){try{if(R===undefined||R.length<=0){throw new j("invalid_keyBlock");}var N=sofo.utils.bytesToHex(R.data);var Q=T.macKey.length,M=T.encKey.length,P=T.iv.length;var S=0;T.macKey.value=sofo.utils.hexToBytes(N.slice(S,Q*2));S+=Q*2;T.server.macKey.value=sofo.utils.hexToBytes(N.slice(S,S+Q*2));S+=Q*2;T.encKey.value=sofo.utils.hexToBytes(N.slice(S,S+M*2));S+=M*2;T.server.encKey.value=sofo.utils.hexToBytes(N.slice(S,S+M*2));S+=M*2;T.iv.value=sofo.utils.hexToBytes(N.slice(S,S+P*2));S+=P*2;T.server.iv.value=sofo.utils.hexToBytes(N.slice(S,S+16*2));}catch(O){if(O.errorMsg){throw new j(O.errorMsg,"[keyBlockToCipherSuite]");}else{throw new j(O.message,"[keyBlockToCipherSuite]");}}}var H=function(M,Q,R){try{G=Q.message.cert;if(!B.isValiedPemFormat(G)){throw new j("invalid_pem_format");}if(M=="secure"){I=B.base64Decode(Q.message.random);u=B.base64Decode(Q.message.sid);var N=JSON.stringify(Q.message);var P=a.hashUpdate(N,s,"sha1");if(B.base64Encode(P.getBytes())!==(o=Q.hash)){throw new j("bad_verify_hash");}t=B.generatorRandom(48);J=B.calcuratorBlock(t,d,I,7);z(J,R);}else{h(m,g);D(g);c=y(g);A=g.encKey.value;q=g.iv.value;p=g.macKey.value;cert=forge.pki.certificateFromPem(G);encryptedKey=cert.publicKey.encrypt(c.data,g.param.publicKeyAlg);}return true;}catch(O){if(O.errorMsg){throw new Error("[AnySign4PC][serverHello]"+O.funcCall+"ErrorMsg : "+O.errorMsg+"("+O.errorCode+")");}else{throw new Error("[AnySign4PC][serverHello]"+O.funcCall+"[Native] ErrorMsg : "+O.message);}}};var L=function(P,U,M){try{var N;var Q=forge.pki.certificateFromPem(M);if(!B.isValiedPemFormat(M)){throw new j("invalid_pem_format");}var O=Q.publicKey.encrypt(t,U.param.publicKeyAlg);var T={messageType:"key_exchange",sid:B.base64Encode(u),envelopedData:B.base64Encode(O)};var S=a.hashUpdate(JSON.stringify(T),o,"sha1");b=B.base64Encode(S.getBytes());P(JSON.stringify(E(T,b)));return true;}catch(R){if(R.errorMsg){throw new Error("[AnySign4PC][serverHello][keyExchange] ErrorMsg : "+R.errorMsg+"("+R.errorCode+")");}else{throw new Error("[AnySign4PC][serverHello][keyExchange][Native] ErrorMsg : "+R.message);}}};var l=function(P){try{var N=a.hashUpdate(B.base64Encode(J.data),"finish","sha1");var M=a.hashUpdate(B.base64Encode(N.data),b,"sha1");if(B.base64Encode(M.data)!==P.hash){throw new j("bad_verify_hash");}else{return "finish";}}catch(O){if(O.errorMsg){throw new Error("[AnySign4PC][finish] ErrorMsg : "+O.errorMsg+"("+O.errorCode+")");}else{throw new Error("[AnySign4PC][finish][Native] ErrorMsg : "+O.message);}}};function x(W,Q,X,Z,O){var N;var U=Z.encKey.value;var S=Z.iv.value;var M=Z.macKey.value;var P;try{var T=B.createBuffer(X,"utf8");if(W=="secure"){P=a.encrypt(X,U,S,Z.param.symKeyAlg);var R={messageType:"application",sid:B.base64Encode(u),encryptedData:B.base64Encode(P)};var Y=a.HMAC(T.data,M);sendMsg=JSON.stringify(E(R,B.base64Encode(Y.data)));}else{P=a.encrypt(X,U,S,Z.param.symKeyAlg);var R={messageType:"application",sid:Q,ciphersuite:Z.value,encryptedKey:B.base64Encode(encryptedKey),encryptedData:B.base64Encode(P)};var Y=a.HMAC(T.data,M);sendMsg=JSON.stringify(C(R,B.base64Encode(Y.data)));}}catch(V){if(V.errorMsg){throw new Error("[AnySign4PC][sendApplication]"+V.funcCall+" ErrorMsg : "+V.errorMsg+"("+V.errorCode+")");}else{throw new Error("[AnySign4PC][sendApplication]"+V.funcCall+"[Native] ErrorMsg : "+V.message);}}return sendMsg;}function F(T,P,V){var R,N,Q;try{if(T=="secure"){N=V.server.macKey.value;R=V.server.encKey.value;Q=V.server.iv.value;}else{N=V.macKey.value;R=V.encKey.value;Q=V.iv.value;}var O=P.message.encryptedData;var W=a.decrypt(B.base64Decode(O),R,Q,V.param.symKeyAlg);var U=a.HMAC(W,N);if(B.base64Encode(U.getBytes())!==P.hash){throw new j("bad_verify_hash");}else{var M;M=B.decodeUTF8(W);if(M===undefined||M==null){throw new j("utf8_decode_fail");}return M;}}catch(S){if(S.errorMsg){throw new Error("[AnySign4PC][receiveApplication] ErrorMsg : "+S.errorMsg+"("+S.errorCode+")");}else{throw new Error("[AnySign4PC][receiveApplication][Native] ErrorMsg : "+S.message);}}}return{start:function(O,N){try{if(O===undefined||O==null){m="secure";}m=O;if(m=="secure"){w["secure"]=new i();var M=w["secure"];h(m,M);D(M);}k(m,N);}catch(P){throw P;}},handShake:function(N,Q){var O=false;try{if(m=="secure"){var M=w["secure"];if(H(m,Q,M)){O=L(N,M,G);}}else{O=H(m,Q);}}catch(P){throw P;}return O;},finish:function(M){return l(M);},end:function(){m=null;var M=w["secure"];if(m==="secure"){M.macKey.value=null;M.encKey.value=null;M.iv.value=null;M.server.macKey.value=null;M.server.encKey.value=null;M.server.iv.value=null;delete w["secure"];J=null;}else{if(m=="envelope"){r=null;v=null;f=null;}}},sendApplication:function(N){var M="";var O;try{if(m=="secure"){g=w["secure"];}O=x(m,M,N,g,G);return O;}catch(P){throw P;}},receiveApplication:function(M){var P=M;var N;try{if(m=="secure"){g=w["secure"];}N=F(m,M,g);return N;}catch(O){throw O;}}};})();
