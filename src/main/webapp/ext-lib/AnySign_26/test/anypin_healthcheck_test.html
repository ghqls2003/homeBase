<!DOCTYPE html>
<html>
<head>
<title>AnyPIN Health Check Test</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="cache-control" content="no-cache">

<script type="text/javascript" src="../anyPinInterface.js"></script>
<script type="text/javascript" src="../AnyPin/ext/anySignjQuery-1.11.1.js"></script>

<script type="text/javascript">

function init()
{
	numbering();
	
	var form = document.form_setAnyPinInterface;
	form.mLanguage.value = AnyPin.mLanguage;
	form.mCharset.value = AnyPin.mCharset;
	form.mLicense.value = AnyPin.mLicense;
	form.mServiceURL.value = AnyPin.mServiceURL;
	form.mServiceKey.value = AnyPin.mServiceKey;
	form.mServiceMode.value = AnyPin.mServiceMode;
	form.mWebWorkerNum.value = AnyPin.mWebWorkerNum;
	form.mWebWorkerScript.value = AnyPin.mWebWorkerScript;
	form.mPinListInfo_delimiter1.value = AnyPin.mPinListInfo.delimiter1;
	form.mPinListInfo_delimiter2.value = AnyPin.mPinListInfo.delimiter2;
	form.mAllowNativeInput.value = AnyPin.mAllowNativeInput;
	form.mXecureKeyPadHTML5_enable.value = AnyPin.mXecureKeyPadHTML5.enable;
	form.mPinMinLen.value = AnyPin.mPinMinLen;
	form.mPinMaxLen.value = AnyPin.mPinMaxLen;
	form.mCaType.value = AnyPin.mCaType;
	form.mWebCMPURL.value = AnyPin.mWebCMPURL;
	
	AnyPin.InitAnyPin();
}

function numbering()
{
	var aElements = document.getElementsByTagName('h3');

	for (i = 0 ; i < aElements.length ; i++)
	{
		aElements[i].innerHTML = (i + 1) + ". " + aElements[i].innerHTML;
		aElements.id = "elem" + (i + 1);
	}
}

function sumCheckbox(aCheckbox)
{
	var aIter;
	var aTotal = 0;

	for(aIter = 0;aIter < aCheckbox.length;aIter++)
	{
		if(aCheckbox[aIter].checked)
			aTotal += parseInt(aCheckbox[aIter].value);
	}
	return aTotal;
}

function getRadio(aRadio)
{
	var aIter;

	for (aIter = 0;aIter < aRadio.length;aIter++)
	{
		if (aRadio[aIter].checked)
			return aRadio[aIter].value;
	}
	return "";
}

</script>
</head>
<body onload="init();">

<h1>AnyPIN Health Check Test</h1>

<hr>


* 공통 변수 설정 (member)

<script type="text/javascript">

function setAnyPinInterface()
{
	var form = document.form_setAnyPinInterface;
	
	AnyPin.mLanguage = form.mLanguage.value;
	AnyPin.mCharset = form.mCharset.value;
	AnyPin.mLicense = form.mLicense.value;
	AnyPin.mServiceURL = form.mServiceURL.value;
	AnyPin.mServiceKey = form.mServiceKey.value;
	AnyPin.mServiceMode = parseInt(form.mServiceMode.value);
	AnyPin.mWebWorkerNum = parseInt(form.mWebWorkerNum.value);
	AnyPin.mWebWorkerScript = form.mWebWorkerScript.value;
	AnyPin.mPinListInfo.delimiter1 = form.mPinListInfo_delimiter1.value;
	AnyPin.mPinListInfo.delimiter2 = form.mPinListInfo_delimiter2.value;
	
	if(form.mAllowNativeInput.value.toLowerCase() == "true")
		AnyPin.mAllowNativeInput = true;
	else
		AnyPin.mAllowNativeInput = false;
	
	if(form.mXecureKeyPadHTML5_enable.value.toLowerCase() == "true")
		AnyPin.mXecureKeyPadHTML5.enable = true;
	else
		AnyPin.mXecureKeyPadHTML5.enable = false;
	
	AnyPin.mPinMinLen = parseInt(form.mPinMinLen.value);
	AnyPin.mPinMaxLen = parseInt(form.mPinMaxLen.value);
	AnyPin.mCaType = parseInt(form.mCaType.value);
	AnyPin.mWebCMPURL = form.mWebCMPURL.value;
}
</script>

<form id="form_setAnyPinInterface" name="form_setAnyPinInterface" action="#">
	<table>
		<tr>
			<td>mLanguage</td>
			<td><input type="text" name="mLanguage" size="80"/></td>
		</tr>
		<tr>
			<td>mCharset</td>
			<td><input type="text" name="mCharset" size="80"/></td>
		</tr>
		<tr>
			<td>mLicense</td>
			<td><input type="text" name="mLicense" size="80"/></td>
		</tr>
		<tr>
			<td>mServiceURL</td>
			<td><input type="text" name="mServiceURL" size="80"/></td>
		</tr>
		<tr>
			<td>mServiceKey</td>
			<td><input type="text" name="mServiceKey" size="80"/></td>
		</tr>
		<tr>
			<td>mServiceMode</td>
			<td><input type="text" name="mServiceMode" size="80"/></td>
		</tr>
		<tr>
			<td>mWebWorkerNum</td>
			<td><input type="text" name="mWebWorkerNum" size="80"/></td>
		</tr>
		<tr>
			<td>mWebWorkerScript</td>
			<td><input type="text" name="mWebWorkerScript" size="80"/></td>
		</tr>
		<tr>
			<td>mPinListInfo.delimiter1</td>
			<td><input type="text" name="mPinListInfo_delimiter1" size="80"/></td>
		</tr>
		<tr>
			<td>mPinListInfo.delimiter2</td>
			<td><input type="text" name="mPinListInfo_delimiter2" size="80"/></td>
		</tr>
		<tr>
			<td>mAllowNativeInput</td>
			<td><input type="text" name="mAllowNativeInput" size="80"/></td>
		</tr>
		<tr>
			<td>mXecureKeyPadHTML5.enable</td>
			<td><input type="text" name="mXecureKeyPadHTML5_enable" size="80"/></td>
		</tr>
		<tr>
			<td>mPinMinLen</td>
			<td><input type="text" name="mPinMinLen" size="80"/></td>
		</tr>
		<tr>
			<td>mPinMaxLen</td>
			<td><input type="text" name="mPinMaxLen" size="80"/></td>
		</tr>
		<tr>
			<td>mCaType</td>
			<td><input type="text" name="mCaType" size="80"/></td>
		</tr>
		<tr>
			<td>mWebCMPURL</td>
			<td><input type="text" name="mWebCMPURL" size="80"/></td>
		</tr>
		<tr>
			<td>run</td>
			<td>
				<input type="button" value="setAnyPinInterface" onclick="setAnyPinInterface()"/>
			</td>
		</tr>
	</table>
</form>
<br>

<hr>


<h3>InitAnyPin</h3>

<script type="text/javascript">
function InitAnyPin()
{
	var form = document.form_InitAnyPin;
	var output = form.output;
	
	var result = AnyPin.InitAnyPin();
	output.value = result;
}
</script>

<form id="form_InitAnyPin" name="form_InitAnyPin" action="#">
	<table>
		<tr>
			<td>member</td>
			<td>
				AnyPin.mLanguage<br>
				AnyPin.mCharset<br>
				AnyPin.mLicense<br>
				AnyPin.mServiceURL<br>
				AnyPin.mServiceKey<br>
				AnyPin.mServiceMode<br>
				AnyPin.mWebWorkerNum<br>
				AnyPin.mWebWorkerScript
			</td>
		</tr>
		<tr>
			<td>run</td>
			<td>
				<input type="button" value="InitAnyPin" onclick="InitAnyPin()"/>
			</td>
		</tr>
		<tr>
			<td>output</td>
			<td><textarea name="output" cols="80" rows="2"></textarea></td>
		</tr>
	</table>
</form>
<br>

<h3>SetPinElement</h3>

<script type="text/javascript">
function SetPinElement()
{
	var form = document.form_SetPinElement;
	var inputType = getRadio(form.inputType);
	var inputCheck = getRadio(form.inputCheck);
	var input1 = form.input1;
	var input2 = form.input2;
	var input3 = form.input3;
	var okFunc = null;
	var closeFunc = null;
	var option = form.option.value;
	var output = form.output;
	
	if(inputCheck == "1") {
		var keyIndex = AnyPin.SetPinElement(inputType, input1, okFunc, closeFunc, option);
		output.value = keyIndex;
	} else if(inputCheck == "2") {
		var keyIndex = AnyPin.SetPinElement(inputType, input2, okFunc, closeFunc, option);
		output.value = keyIndex;
	} else if(inputCheck == "3") {
		var keyIndex = AnyPin.SetPinElement(inputType, input3, okFunc, closeFunc, option);
		output.value = keyIndex;
	}
}
</script>

<form id="form_SetPinElement" name="form_SetPinElement" action="#">
	<table>
		<tr>
			<td>member</td>
			<td>
				AnyPin.mAllowNativeInput<br>
				AnyPin.mXecureKeyPadHTML5.enable
			</td>
		</tr>
		<tr>
			<td>inputType</td>
			<td>
				<input type="radio" name="inputType" value="0" checked/> 0 : 일반 입력<br>
				<input type="radio" name="inputType" value="13"/> 13 : XecureKeypad HTML5
			</td>
		</tr>
		<tr>
			<td>inputElement</td>
			<td>
			<div id="intput1_div">
				<input type="radio" name="inputCheck" value="1" checked/><input type="text" id="input_1" name="input1" size="80"/>
			</div>
			<div id="intput2_div">
				<input type="radio" name="inputCheck" value="2"/><input type="text" id="input_2" name="input2" size="80"/>
			</div>
			<div id="intput3_div">
				<input type="radio" name="inputCheck" value="3"/><input type="text" id="input_3" name="input3" size="80"/>
			</div>
			</td>
		</tr>
		<tr>
			<td>okCallback</td>
			<td><input type="text" name="okCallback" size="80" disabled="true" value="function"/></td>
		</tr>
		<tr>
			<td>closeCallback</td>
			<td><input type="text" name="closeCallback" size="80" disabled="true" value="function"/></td>
		</tr>
		<tr>
			<td>option</td>
			<td><input type="text" name="option" size="80"/></td>
		</tr>
		<tr>
			<td>run</td>
			<td>
				<input type="button" value="SetPinElement" onclick="SetPinElement()"/><br>
			</td>
		</tr>
		<tr>
			<td>output</td>
			<td><textarea name="output" cols="80" rows="2"></textarea></td>
		</tr>
	</table>
</form>
<br>

<h3>GetPinIDList</h3>

<script type="text/javascript">
function GetPinIDList()
{
	var form = document.form_apnGetPinIDList;
	var userid = form.userid.value;
	var option = sumCheckbox(form.option);
	var output = form.output;
	
	var userCallback = function(result) {
		output.value = result;
	}
	
	var errCallback = function(result) {
		alert("[" + result.code + "] " +result.msg.replace(/\\n/g, '\r\n'));
	}
	
	AnyPin.GetPinIDList(userid, option, userCallback, errCallback);
}
</script>

<form id="form_apnGetPinIDList" name="form_apnGetPinIDList" action="#">
	<table>
		<tr>
			<td>member</td>
			<td>
				AnyPin.mPinListInfo.delimiter1<br>
				AnyPin.mPinListInfo.delimiter2
			</td>
		</tr>
		<tr>
			<td>userid</td>
			<td><input type="text" name="userid" size="80"/></td>
		</tr>
		<tr>
			<td>option</td>
			<td>
				<input type="checkbox" name="option" value="0" checked disabled="true"/> 0x00 : default - ID (userid 입력 시 미출력)<br>
				<input type="checkbox" name="option" value="1"/> 0x01 : Nickname<br>
				<input type="checkbox" name="option" value="2"/> 0x02 : Input Type<br>
				<input type="checkbox" name="option" value="4"/> 0x04 : Last Time<br>
				<input type="checkbox" name="option" value="16"/> 0x10 : 등록된 Pin 개수<br>
			</td>
		</tr>
		<tr>
			<td>run</td>
			<td>
				<input type="button" value="GetPinIDList" onclick="GetPinIDList()"/><br>
			</td>
		</tr>
		<tr>
			<td>output</td>
			<td><textarea name="output" cols="80" rows="2"></textarea></td>
		</tr>
	</table>
</form>
<br>

<h3>InitRegist</h3>

<script type="text/javascript">
function InitRegist()
{
	var form = document.form_InitRegist;
	var userid = form.userid.value;
	var option = form.option.value;
	var output = form.output;
	
	var userCallback = function(result) {
		output.value = result;
	}
	
	var errCallback = function(result) {
		alert("[" + result.code + "] " +result.msg.replace(/\\n/g, '\r\n'));
	}
	
	AnyPin.InitRegist(userid, option, userCallback, errCallback);
}
</script>

<form id="form_InitRegist" name="form_InitRegist" action="#">
	<table>
		<tr>
			<td>userid</td>
			<td><input type="text" name="userid" size="80"/></td>
		</tr>
		<tr>
			<td>option</td>
			<td><input type="text" name="option" size="80"/></td>
		</tr>
		<tr>
			<td>run</td>
			<td>
				<input type="button" value="InitRegist" onclick="InitRegist()"/><br>
			</td>
		</tr>
		<tr>
			<td>output</td>
			<td><textarea name="output" cols="80" rows="2"></textarea></td>
		</tr>
	</table>
</form>
<br>


<h3>SetRequestCertRaFunc</h3>

<script type="text/javascript">
var aRaType = "xecureca";
var aRaPage = "../test/user_regist_anypin.jsp";

var time2;
function requestCertRaFunc(callback, param)
{
	var form = document.form_RegistPin;
	var ra_result = form.ra_result;
	
	ra_result.value = "id:" + param.id + "\n" + "deviceId:" + param.deviceId + "\n";
	
	var req= new XMLHttpRequest ();
	var url = aRaPage;
	url += "?commandType=new";
	url += "&user_policy_type=104";
	url += "&targetRA=2048";
	url += "&user_public_or_private=" + aRaType;
	url += "&user_id=" + param.deviceId;
	url += "&real_id=" + param.id;
	
	req.open ("GET", url, false);
	req.send (null);
	
	var res = eval (req.responseText);
	
	if (parseInt (res["code"]) == 0) {
		
		var refNum = res["refcode"];
		var authCode = res["authcode"];
		var name = res["name"];
		var ssn = res["ssn"];
		var userid = res["userid"];
		var realid = res["realid"];
		var check_real_id = res["check_real_id"];
		var cert_status = res["cert_status"];
		
		ra_result.value += "[등록 결과]\n" + 
			"refcode:" + refNum + "\n" +
			"authcode:" + authCode + "\n" +
			"name:" + name + "\n" +
			"ssn:" + ssn + "\n" +
			"userid(deviceId):" + userid + "\n" +
			"realid(id):" + realid + "\n" +
			"check_real_id(id):" + check_real_id + "\n" +
			"cert_status:" + cert_status;
		
		time2 = new Date();
		callback(refNum, authCode);
	} else {
		ra_result.value += "[등록 결과]\n" +
			"code:" + res["code"] + "\n" +
			"reason:" + res["reason"] + "\n" +
			"moreInformation:" + res["moreinformation"] + "\n";
	}
}

function SetRequestCertRaFunc()
{
	var form = document.form_SetRequestCertRaFunc;
	var output = form.output;
	
	AnyPin.SetRequestCertRaFunc(requestCertRaFunc);
	output.value = "ok";
}
</script>

<form id="form_SetRequestCertRaFunc" name="form_SetRequestCertRaFunc" action="#">
	<table>
		<tr>
			<td>raCallback</td>
			<td><input type="text" name="raCallback" size="80" disabled="true" value="function"/></td>
		</tr>
		<tr>
			<td>run</td>
			<td>
				<input type="button" value="SetRequestCertRaFunc" onclick="SetRequestCertRaFunc()"/><br>
			</td>
		</tr>
		<tr>
			<td>output</td>
			<td><textarea name="output" cols="80" rows="2"></textarea></td>
		</tr>
	</table>
</form>
<br>


<h3>RegistPin</h3>

<script type="text/javascript">
function RegistPin()
{
	var form = document.form_RegistPin;
	var userid = form.userid.value;
	var keyIndex = form.keyIndex.value;
	var nickname = form.nickname.value;
	var description = form.description.value;
	var option = sumCheckbox(form.option);
	var output = form.output;
	
	var time1 = new Date();
	var userCallback = function(result) {
		var time3 = new Date();
		var time_ra = new Date(time2 - time1);
		var time_result = new Date(time3 - time1);
		
		output.value = "RA 등록 시간: " + time_ra.getMinutes() + " 분 " + time_ra.getSeconds() + " 초\r\n"
		output.value += "최종 등록 시간: " + time_result.getMinutes() + " 분 " + time_result.getSeconds() + " 초\r\n"
		output.value += result;
	}
	
	var errCallback = function(result) {
		alert("[" + result.code + "] " +result.msg.replace(/\\n/g, '\r\n'));
	}
	
	AnyPin.RegistPin(userid, nickname, description, keyIndex, option, userCallback, errCallback);
}
</script>

<form id="form_RegistPin" name="form_RegistPin" action="#">
	<table>
		<tr>
			<td>member</td>
			<td>
				AnyPin.mServiceMode<br>
				AnyPin.mCaType<br>
				AnyPin.mWebCMPURL
			</td>
		</tr>
		<tr>
			<td>userid</td>
			<td><input type="text" name="userid" size="80"/></td>
		</tr>
		<tr>
			<td>keyIndex</td>
			<td><input type="text" name="keyIndex" size="80"/></td>
		</tr>
		<tr>
			<td>nickname</td>
			<td><input type="text" name="nickname" size="80"/></td>
		</tr>
		<tr>
			<td>description</td>
			<td><input type="text" name="description" size="80"/></td>
		</tr>
		<tr>
			<td>option</td>
			<td>
				<input type="checkbox" name="option" value="0" checked disabled="true"/> 0x00 : 기본값<br>
				<input type="checkbox" name="option" value="1"/> 0x01 : nickname 서버로 전송<br>
				<input type="checkbox" name="option" value="2"/> 0x02 : description 서버로 전송<br>
				<input type="checkbox" name="option" value="4"/> 0x04 : 사용자 기기정보(getDeviceInfo) 서버로 전송<br>
			</td>
		</tr>
		<tr>
			<td>run</td>
			<td>
				<input type="button" value="RegistPin" onclick="RegistPin()"/><br>
			</td>
		</tr>
		<tr>
			<td>ra_result</td>
			<td><textarea name="ra_result" cols="80" style="height:220px"></textarea></td>
		</tr>
		<tr>
			<td>output</td>
			<td><textarea name="output" cols="80" rows="4"></textarea></td>
		</tr>
	</table>
</form>
<br>


<h3>InitSession</h3>

<script type="text/javascript">
function InitSession()
{
	var form = document.form_InitSession;
	var userid = form.userid.value;
	var option = form.option.value;
	var output = form.output;
	
	var userCallback = function(result) {
		output.value = result;
	}
	
	var errCallback = function(result) {
		alert("[" + result.code + "] " +result.msg.replace(/\\n/g, '\r\n'));
	}
	
	AnyPin.InitSession(userid, option, userCallback, errCallback);
}
</script>

<form id="form_InitSession" name="form_InitSession" action="#">
	<table>
		<tr>
			<td>userid</td>
			<td><input type="text" name="userid" size="80"/></td>
		</tr>
		<tr>
			<td>option</td>
			<td><input type="text" name="option" size="80"/></td>
		</tr>
		<tr>
			<td>run</td>
			<td>
				<input type="button" value="InitSession" onclick="InitSession()"/><br>
			</td>
		</tr>
		<tr>
			<td>output</td>
			<td><textarea name="output" cols="80" rows="2"></textarea></td>
		</tr>
	</table>
</form>
<br>

<h3>Server Monitoring</h3>

<script type="text/javascript">

var monitorTimer = null;
var timelevel = 1000;
var singleton = false;

function getLogTime ()
{
	function pad2(n) { return n < 10 ? '0' + n : n }

	var date = new Date();
	return "[" + date.getFullYear().toString() + pad2(date.getMonth() + 1) + pad2( date.getDate()) + pad2( date.getHours() ) + pad2( date.getMinutes() ) + pad2( date.getSeconds() ) + "] ";
}

function autoscrollup (outprint)
{
	outprint.scrollTop = outprint.scrollHeight;
}

function LauncherMonitor()
{
	var form = document.form_Monitoring;
	var userid = form.userid.value;
	var option = form.option.value;
	var cmppacket = form.cmppacket.value;
	var intervalTime = form.intervalTime.value;
	var outputloop = form.outputloop;
	var timeprint = form.looptimeprint;

	var restart = false;

	if(intervalTime < 1) intervalTime = 1;

	if(singleton) return;

	singleton = true;

	if( monitorTimer !== null)
	{
		outputloop.value += "================ RESTART MONITORING ==============\n";
		autoscrollup(outputloop);
		clearTimeout(monitorTimer);

		restart = true;
	}

	if(!restart)
	{
		outputloop.value += "================ START MONITORING ================\n";
		autoscrollup(outputloop);
	}

	function monitoring_loop()
	{
		var timelogstring = "";
		var resultString = "";

		var checkWebCMPServerLive = function() {

			SofoAnySignJQuery.ajax({
				"url": AnyPin.mWebCMPURL,
				"type": "POST",
				"dataType": "html",
				"headers" : {"Content-type":"application/pkixcmp"},
				"timeout": 10000,
				"data": cmppacket
			}).done(function(data, textStatus, jqxhr) {
				if(textStatus.indexOf("success") !== -1)
				{					
					if(jqxhr.status === 200)
					{
						resultString += "CMP = Live\n";
					}
					else
					{
						resultString += "CMP = Live but = [response status code = " + jqxhr.status + "]\n";
					}
				}
				else
				{
					resultString += "CMP = Live but = [response textStatus = " + textStatus + "]\n";
				}

				if(timeprint.checked == true)
				{
					timelogstring = getLogTime();
				}

				outputloop.value += timelogstring + resultString;
				autoscrollup(outputloop);

				monitorTimer = setTimeout(monitoring_loop, intervalTime*timelevel);

				singleton = false;

			}).fail(function(jqxhr, textStatus, errorThrown) {
				resultString += "CMP = FAIL = [response textStatus = " + textStatus + "/errorThrown = " + errorThrown + "]\n";

				if(timeprint.checked == true)
				{
					timelogstring = getLogTime();
				}

				outputloop.value += timelogstring + resultString;
				autoscrollup(outputloop);

				monitorTimer = setTimeout(monitoring_loop, intervalTime*timelevel)

				singleton = false;
			});
		}

		var userCallback = function(result) {
			if(result.indexOf("success") !== -1)
			{
				resultString = "APN = Live\t\t";
			}
			else
			{
				resultString = "APN = Live but NOT success = [" + result + "]\t";
			}

			checkWebCMPServerLive();
		}
		
		var errCallback = function(result) {
			resultString = "APN = FAIL = [code:" + result.code + ", message : " + result.msg + "]\t";

			checkWebCMPServerLive();
		}
		
		AnyPin.InitSession(userid, option, userCallback, errCallback);
	}

	monitoring_loop();
}

function StopMonitor()
{
	var form = document.form_Monitoring;
	var outputloop = form.outputloop;

	outputloop.value += "================ STOP MONITORING =================\n";
	clearTimeout(monitorTimer);
	monitorTimer = null;
}
</script>

<form id="form_Monitoring" name="form_Monitoring" action="#">
	<table>
		<tr>
			<td>userid</td>
			<td><input type="text" name="userid" size="80"/></td>
		</tr>
		<tr>
			<td>option</td>
			<td><input type="text" name="option" size="80"/></td>
		</tr>
		<tr>
			<td>interval time</td>
			<td><input type="text" name="intervalTime" value=1 size="80"/></td>
		</tr>
		<tr>
			<td>log time</td>
			<td><input type="checkbox" name="looptimeprint" value="0" checked/> show time<br></td>
		</tr>
		<tr>
			<td>WebCMP Packet</td>
			<td><input type="text" name="cmppacket" size="80" value="AAAAThAAADBJMEMCAQCBASCBA1BLSaIGBAQzMjg0owYEBDAwMDCkEgQQnZMecYafz21skYSiUWIqrqUSBBB7qCwqSSPbReLk/KCEnIjOtQIwAA=="/></td>
		</tr>
		<tr>
			<td>run monitoring</td>
			<td>
				<input type="button" value="Start" onclick="LauncherMonitor()"/>
				<input type="button" value="Stop" onclick="StopMonitor()"/>
			</td>
		</tr>
		<tr>
			<td>output loop</td>
			<td><textarea name="outputloop" cols="80" rows="50"></textarea></td>
		</tr>
	</table>
</form>
<br>
</body>
</html>
